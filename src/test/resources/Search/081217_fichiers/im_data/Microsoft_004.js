// Copyright (c) Microsoft Corporation. All rights reserved.

Type.createNamespace('MSCh');MSCh._H$1=function(){};MSCh._H$1.createInterface('MSCh._H$1');MSCh._H$2=function(){};MSCh._H$2.prototype = {$0:0,$1:1,$2:2,$3:3,$4:4,$5:5}
MSCh._H$2.createEnum('MSCh._H$2',false);MSCh._H$3=function(){};MSCh._H$3.prototype = {$0:0,$1:1,$2:2,$3:3,$4:4,$5:5}
MSCh._H$3.createEnum('MSCh._H$3',false);MSCh._H$0=function(){};MSCh._H$0.prototype = {$0:1,$1:2,$2:3,$3:4}
MSCh._H$0.createEnum('MSCh._H$0',false);MSCh._H$B=function(numChunks,startChunk){this.$0=numChunks;this.$2=new Array(this.$0);this.$2[0]=startChunk;this.$3=[];this.$3.add(0);this.$4=Date.get_now();this.$1++;}
MSCh._H$B.prototype={$0:0,$1:0,$2:null,$3:null,$4:null,get_$5:function(){return (this.$1>=this.$0);},get_$6:function(){return this.$4;},$7:function($p0,$p1){if(this.get_$5()||$p0>=this.$0||this.$3.contains($p0)){return false;}this.$2[$p0]=$p1;this.$3.add($p0);this.$4=Date.get_now();this.$1++;return true;},toString:function(){var $0;$0=new StringBuilder();$0.append(this.$2[0]);for(var $1=1;$1<this.$0;$1++){$0.append(this.$2[$1]);}return $0.toString();}}
MSCh._H$A=function(id,service,events,initialAddress){this.id=id;this.$0=service;this.$2=events;this.$4=[];this.$4.add(initialAddress);switch(initialAddress.type){case 0:case 2:case 1:this.$1=new MSCh._H$16(this,this.$2);break;case 8:case 16:case 4:case 32:this.$1=new MSCh._H$D(this,this.$2);break;default:break;}}
MSCh._H$A.prototype={id:null,$0:null,$1:null,$2:null,$3:false,$4:null,get_id:function(){return this.id;},get_$5:function(){return this.$0;},get_$6:function(){return this.$3;},set_$6:function($p0){this.$3=$p0;return $p0;},get_$7:function(){return this.$1.get_$2();},get_$8:function(){return this.$4;},$9:function($p0){var $enum1=this.$4.getEnumerator();while($enum1.moveNext()){var $0=$enum1.get_current();if(($p0.address===$0.address)&&($p0.type===$0.type)){return $0;}}return null;},$A:function(){var $0=this.$4[0];if($0.address===this.$0.get_liveId()){if(this.$4.length>1){return this.$4[1];}return null;}return $0;},$B:function(){this.$1.$5();},$C:function($p0,$p1){this.$1.$7($p0,$p1);},$D:function($p0,$p1){this.$1.$6($p0,$p1);},$E:function($p0){this.$1=$p0;},$F:function($p0){var $0=this.id;this.id=$p0;this.$0.conversationUpdateId($0,$p0);},$10:function($p0){$p0.$5();},$11:function($p0,$p1,$p2){this.$2.onConversationInviteAddressCompleted(this.id,$p0,$p1,$p2);},$12:function($p0){if(this.$9($p0)){return;}this.$4.add($p0);if(this.$4.length>2){this.$F(MSCh._H$6.$7());}if(this.$3){this.$1.$9($p0);}},$13:function($p0){$p0=this.$9($p0);if(this.$4.length>2){this.$4.remove($p0);if(this.$4.length===2){var $0=this.$4[0];if(($0.address===this.get_$5().get_liveId())&&($0.type===1)){$0=this.$4[1];}var $1=$0.address+':'+($0.type);if(!this.$0.containsConnectedId($1)){this.$F($1);}}if(this.$3){this.$1.$A($p0);}}},$14:function($p0){if(!this.$3&&$p0.type===255){return;}if($p0.type===1){var $0=$p0.info;if(this.$0.isBlockedMessage($0.text)){MSCo.LogHelper.logError('Chat.Conversation.OnMessageReceived','ignoring blocked message');return;}}if(!this.get_$6()){this.$3=true;this.$0.conversationExpose(this.id,this.$4);}this.$1.$8($p0);},$15:function($p0,$p1){if($p0.type!==255){this.$1.$B($p0,$p1);}},$16:function($p0,$p1,$p2){var $0=Type.safeCast(this.$1,MSCh._H$C);if(!$0){return;}$0.$13($p0,$p1,$p2);},onMixerAddressLeft:function($p0){var $0=Type.safeCast(this.$1,MSCh._H$C);if(!$0){return;}$0.$12($p0);},onMixerAddressJoined:function($p0){var $0=Type.safeCast(this.$1,MSCh._H$C);if(!$0){return;}$0.$E($p0);},onMixerInitialAddressJoined:function($p0,$p1,$p2){var $0=Type.safeCast(this.$1,MSCh._H$C);if(!$0){return;}$0.$F($p0,$p1,$p2);},onMixerReceivedMessage:function($p0){var $0=Type.safeCast(this.$1,MSCh._H$C);if(!$0){return;}$0.$11($p0);},onMixerDisconnected:function(){var $0=Type.safeCast(this.$1,MSCh._H$C);if(!$0){return;}$0.$D();}}
MSCh.ConversationService=function(identity,service,serviceEvents){this.$4=identity;this.$1=service;this.$2=serviceEvents;this.$3=[];this.$0={};}
MSCh.ConversationService.prototype={$0:null,$1:null,$2:null,$3:null,$4:null,$5:false,get_liveId:function(){return this.$4.liveId;},get_localEndpoint:function(){return this.$4.endpointId;},get_$6:function(){return this.$5;},containsConnectedId:function(id){if(Object.keyExists(this.$0,id)){return (this.$0[id]).get_$7();}return false;},isBlockedMessage:function(textMessage){var $enum1=this.$3.getEnumerator();while($enum1.moveNext()){var $0=$enum1.get_current();if(MSCh._H$7.$0($0,textMessage,'i')){return true;}}return false;},$7:function($p0){if(Object.keyExists(this.$0,$p0)){return this.$0[$p0];}else{return null;}},conversationCreate:function(id,address){if(!this.containsConnectedId(id)){var $0=new MSCh._H$A(id,this,this,address);$0.set_$6(true);this.$0[id]=$0;}else{var $1=this.$0[id];$1.set_$6(true);}},conversationSendMessage:function(id,message,userState){var $0=this.$7(id);if(!$0){return;}if(message.type===1){var $1=message.info;if(this.isBlockedMessage($1.text)){$0.$15(message,userState);return;}}$0.$D(message,userState);},conversationInviteAddress:function(id,address,userState){var $0=this.$7(id);if(!$0){return;}$0.$C(address,userState);},conversationClose:function(id){var $0=this.$7(id);if(!$0){return;}$0.$B();if($0.get_$8().length>2){delete this.$0[id];}else{$0.set_$6(false);}},conversationExpose:function(id,roster){this.$1.conversationExpose(id,roster);},conversationUpdateId:function(oldId,newId){var $0=this.$0[oldId];var $1=Object.keyExists(this.$0,newId);if($1){$0.set_$6((this.$0[newId]).get_$6());}this.$0[newId]=$0;delete this.$0[oldId];if($0.get_$6()&&!$1){this.$1.conversationUpdateId(oldId,newId);}},sendPage:function(address,messageType,messagePayload,callback,userState){this.$1.sendPage(address,messageType,messagePayload,callback,userState);},requestMixerSession:function(onResponse){this.$1.requestMixerSession(onResponse);},onPolicyReceived:function(xmlBlob){var $0=MSCo.XmlHelper.parseXmlDocument(xmlBlob);var $1=$0.selectNodes('/config/block/regexp/imtext');this.$3.clear();for(var $2=0;$2<$1.length;$2++){var $3=MSCo.XmlHelper.xmlNodeValue($1[$2]);if(!String.isNullOrEmpty($3)){try{this.$3.add(MSCh._H$5.$1($3));}catch($4){}}}},onPageReceived:function(message,senderAddress,receiverAddress){var $0=MSCh._H$8.$6(senderAddress,new MSM.MimeParser(message));if(!$0){MSCo.LogHelper.logError('Chat.ConversationService.OnPageReceived','Could not parse page message, ignoring');return;}var $1=senderAddress;if((senderAddress.type===1)&&(senderAddress.address===this.$4.liveId)){$1=receiverAddress;}var $2=$1.address+':'+($1.type);var $3=this.$7($2);if(!$3){$3=new MSCh._H$A($2,this,this,$1);this.$0[$2]=$3;}$3.$14($0);},onMixerIncomingRequest:function(inviter,hostName,sessionId,sessionCookie){var $0=MSCh._H$6.$7();var $1;$1=new MSCh._H$A($0,this,this,inviter);$1.$16(hostName,sessionId,sessionCookie);this.$0[$0]=$1;},close:function(){if(this.$5){return;}this.$5=true;var $0=[];var $dict1=this.$0;for(var $key2 in $dict1){var $1={key:$key2,value:$dict1[$key2]};$0.add($1.key);}var $enum3=$0.getEnumerator();while($enum3.moveNext()){var $2=$enum3.get_current();this.conversationClose($2);}},onConversationInviteAddressCompleted:function(id,resultCode,address,userState){this.$2.onConversationInviteAddressCompleted(id,resultCode,address,userState);},onConversationAddressJoined:function(id,address){this.$2.onConversationAddressJoined(id,address);},onConversationAddressLeft:function(id,address){this.$2.onConversationAddressLeft(id,address);},onConversationMessageReceived:function(id,message){this.$2.onConversationMessageReceived(id,message);},onConversationSendMessageFailed:function(id,message,userState){this.$2.onConversationSendMessageFailed(id,message,userState);}}
MSCh._H$10=function(hostName,events){MSCh._H$10.constructBase(this,['SB',hostName]);this.$1_0=events;this.$1_1={};}
MSCh._H$10.$1_13=function($p0){if(String.isNullOrEmpty($p0)){return [0];}var $0=MSCo.StringHelper.splitChar($p0,':');var $1=new Array($0.length);for(var $2=0;$2<$1.length;$2++){var $3=MSCh._H$6.$4($0[$2]);if($3===-1){$1[$2]=0;}else{$1[$2]=$3;}}return $1;}
MSCh._H$10.prototype={$1_0:null,$1_1:null,$1_2:function($p0,$p1,$p2,$p3,$p4){this.sendCommand(['ANS',this.get_nextTrid(),MSCh._H$6.$0($p0)+';'+$p1,$p2,$p3],$p4);},$1_3:function($p0,$p1){this.sendCommand(['CAL',this.get_nextTrid(),MSCh._H$6.$0($p0.address)],$p1);},$1_4:function($p0,$p1,$p2){this.sendCommand(['MSG',this.get_nextTrid(),$p0,$p1],$p2);},$1_5:function(){this.sendCommand(['OUT',this.get_nextTrid()],null);},$1_6:function($p0,$p1,$p2,$p3){this.sendCommand(['USR',this.get_nextTrid(),MSCh._H$6.$0($p0)+';'+$p1,$p2],$p3);},$1_7:function($p0){if($p0.length!==1){this.$1_F('ACK',$p0);return;}},$1_8:function($p0){if($p0.length!==1&&$p0.length!==2){this.$1_F('BYE',$p0);return;}if($p0[0].indexOf(';')===-1){var $0=MSCo.StringHelper.splitChar($p0[0],';')[0];var $1=MC.$create_IMAddressInfo($0,0,0);this.$1_0.onMixerAddressLeft($1);}},$1_9:function($p0){if($p0.length!==5&&$p0.length!==6){this.$1_F('IRO',$p0);return;}if($p0[3].indexOf(';')===-1){var $0=MSCh._H$6.$2($p0[1]);var $1=MSCh._H$6.$2($p0[2]);var $2=this.$1_14($p0[3],$p0[5]);this.$1_0.onMixerInitialAddressJoined($0,$1,$2);}},$1_A:function($p0){if($p0.length!==2&&$p0.length!==3){this.$1_F('JOI',$p0);return;}if($p0[0].indexOf(';')===-1){var $0=this.$1_14($p0[0],$p0[2]);this.$1_0.onMixerAddressJoined($0);}},$1_B:function($p0){if($p0.length!==3){this.$1_F('MSG',$p0);return;}this.$1_12();var $0=MSCh._H$6.$3($p0[0]);var $1=MSCh._H$6.$3($p0[1]);$1=(($1!==$0)?$1:'');var $2=MC.$create_IMAddressInfo($0,0,0);var $3=new MSM.MimeParser($p0[2]);var $4=($3.getHeader('Message-ID'));var $5=($3.getHeader('Chunks'));var $6=($3.getHeader('Chunk'));if($4&&($5||$6)){this.$1_11($2,$5,!$5,$3);}else{this.$1_10($2,$3);}},$1_C:function($p0){if($p0.length!==1){this.$1_F('NAK',$p0);return;}var $0=this.getPendingCommand(MSCh._H$6.$1($p0[0]));if($0){$0.onComplete(500,null);}},$1_D:function($p0,$p1){if($p1.length<0){this.$1_F($p0,$p1);return;}var $0=this.getPendingCommand(MSCh._H$6.$1($p1[0]));if($0){$0.onComplete(0,null);}},$1_E:function($p0,$p1){var $0=this.getPendingCommand($p1);if($0){$0.onComplete($p0,null);}},$1_F:function($p0,$p1){},$1_10:function($p0,$p1){var $0=MSCh._H$8.$6($p0,$p1);if($0){this.$1_0.onMixerReceivedMessage($0);}else{var $1=MSCo.StringHelper.splitChar($p1.getHeader('Content-Type'),';')[0];switch($1){case 'text/x-msmsgsinvite':var $2=new MSM.MimeParser($p1.getBody());var $3=$2.getHeader('Invitation-Cookie');if($3){var $4=new StringBuilder();$4.append('MIME-Version: 1.0\r\nContent-Type: text/x-msmsgsinvite; charset=UTF-8\r\n\r\n');$4.append('Invitation-Command: CANCEL\r\n');$4.append('Invitation-Cookie: ');$4.append($3);$4.append('\r\n');$4.append('Cancel-Code: REJECT_NOT_INSTALLED\r\n\r\n');this.sendCommand(['MSG',this.get_nextTrid(),'N',$4.toString()],null);}break;}}},$1_11:function($p0,$p1,$p2,$p3){var $0=$p3.getHeader('Message-ID');if($p1){if(!Object.keyExists(this.$1_1,$0)){var $1=MSCh._H$6.$4($p3.getHeader('Chunks'));if($1===1){this.$1_10($p0,$p3);}else if($1>1){this.$1_1[$0]=new MSCh._H$B($1,$p3.getHeaders()+'\r\n\r\n'+$p3.getBody());}else{MSCo.LogHelper.logError('Chat.MixerConnection.OnChunkedMessageReceived','dropping invalid chunked message (\'Chunks\' header < 1)');}}}else if(Object.keyExists(this.$1_1,$0)){var $2=MSCh._H$6.$4($p3.getHeader('Chunk'));if($2>0){var $3=this.$1_1[$0];if($3.$7($2,$p3.getBody())){if($3.get_$5()){delete this.$1_1[$0];this.$1_10($p0,new MSM.MimeParser($3.toString()));}}else{MSCo.LogHelper.logError('Chat.MixerConnection.OnChunkedMessageReceived','dropping invalid chunked message (could not add)');delete this.$1_1[$0];}}else{MSCo.LogHelper.logError('Chat.MixerConnection.OnChunkedMessageReceived','dropping invalid chunked message (\'Chunk\' <= 0)');delete this.$1_1[$0];}}else{MSCo.LogHelper.logError('Chat.MixerConnection.OnChunkedMessageReceived','Ignoring unknown chunk');}},$1_12:function(){if(Object.getKeyCount(this.$1_1)>0){var $0=Date.get_now().getTime();var $dict1=this.$1_1;for(var $key2 in $dict1){var $1={key:$key2,value:$dict1[$key2]};var $2=$1.value;var $3=$2.get_$6().getTime();if($0-$3>40000){delete this.$1_1[$1.key];}}}},$1_14:function($p0,$p1){$p0=MSCo.StringHelper.splitChar($p0,';')[0];var $0=1;var $1=MSCh._H$10.$1_13($p1);if($1.length>0){if(($1[0]&2048)){$0=2;}}return MC.$create_IMAddressInfo($p0,$0,0);},onDisconnected:function($p0){this.$1_0.onMixerDisconnected();},onCommandReceived:function($p0){var $0=$p0.get_allParameters();switch($p0.get_name()){case 'ANS':case 'CAL':case 'USR':this.$1_D($p0.get_name(),$0);break;case 'ACK':this.$1_7($0);break;case 'BYE':this.$1_8($0);break;case 'IRO':this.$1_9($0);break;case 'JOI':this.$1_A($0);break;case 'MSG':this.$1_B($0);break;case 'NAK':this.$1_C($0);break;default:var $1=MSCh._H$6.$4($p0.get_name());if($1<0){return;}var $2=MSCh._H$6.$1($0[0]);this.$1_E($1,$2);break;}}}
MSCh._H$9=function(){}
MSCh._H$9.prototype={$0:null,$1:false,$2:false,$3:false,get_$4:function(){return this.$2;},$5:function(){this.$0=Date.get_now();this.$1=true;this.$6();},$7:function(){if(!this.$3){this.$3=true;this.$A();}},$8:function(){if(!this.$3){this.$3=true;this.$A();}},$9:function(){if(!this.$3){this.$3=true;this.$2=true;if(this.$C){this.$C.invoke(this,EventArgs.Empty);}this.$A();}},add_$B:function($p0){this.$C=Delegate.combine(this.$C,$p0);},remove_$B:function($p0){this.$C=Delegate.remove(this.$C,$p0);},$C:null}
MSCh._H$E=function(currState,connection,address,userState){MSCh._H$E.constructBase(this);this.$D=currState;this.$E=connection;this.$F=address;this.$10=userState;}
MSCh._H$E.prototype={$D:null,$E:null,$F:null,$10:null,$6:function(){this.$E.$1_3(this.$F,Delegate.create(this,this.$11));},$A:function(){},$11:function($p0,$p1){if($p0){this.$D.$10(1,this.$F,this.$10);}}}
MSCh._H$F=function(currState,messageInfo,userState){MSCh._H$F.constructBase(this);this.$D=messageInfo;this.$E=currState;this.$F=userState;}
MSCh._H$F.prototype={$D:null,$E:null,$F:null,get_$10:function(){return this.$D;},get_$11:function(){return this.$E;},get_$12:function(){return this.$F;}}
MSCh._H$13=function(currState,connection,messageInfo,userState){MSCh._H$13.constructBase(this,[currState,messageInfo,userState]);this.$13=connection;}
MSCh._H$13.prototype={$13:null,$14:false,$6:function(){var $0='N';if(this.get_$10().type===255){$0='U';}var $1=MSCh._H$8.$4(this.get_$10());for(var $2=0;$2<$1.length;$2++){this.$13.$1_4($0,$1[$2],Delegate.create(this,this.$15));}},$A:function(){},$15:function($p0,$p1){if($p0){if(this.$14){return;}this.$14=true;this.get_$11().$B(this.get_$10(),this.get_$12());}}}
MSCh._H$14=function(currState,service,address,message,userState){MSCh._H$14.constructBase(this,[currState,message,userState]);this.$13=address;this.$14=service;}
MSCh._H$14.prototype={$13:null,$14:null,$6:function(){var $0=MSCh._H$8.$4(this.get_$10());this.$14.sendPage(this.$13,MSCh._H$8.$1(this.get_$10().type),$0[0],Delegate.create(this,this.$15),this.get_$12());},$A:function(){},$15:function($p0){if($p0){this.get_$11().$B(this.get_$10(),this.get_$12());}}}
MSCh._H$4=function(conversation,events){this.$0=conversation;this.$1=events;}
MSCh._H$4.prototype={$0:null,$1:null,get_$3:function(){return this.$0;},get_$4:function(){return this.$1;},$5:function(){},$6:function($p0,$p1){},$7:function($p0,$p1){},$8:function($p0){},$9:function($p0){},$A:function($p0){},$B:function($p0,$p1){}}
MSCh._H$12=function(connection,conversation,events){MSCh._H$12.constructBase(this,[conversation,events]);this.$15=connection;this.$16=[];if((this.get_$3().get_$8().length===2)&&(this.get_$3().get_id().indexOf(':')===-1)){var $0=this.get_$3().$A();var $1=$0.address+':'+($0.type);if(this.get_$3().get_$5().containsConnectedId($1)){var $2=this.get_$3().get_$5().$7($1);if(this.get_$3()!==$2){$2.$B();this.get_$3().$F($1);}}else{this.get_$3().$F($1);}}}
MSCh._H$12.prototype={$15:null,$16:null,$5:function(){var $0=false;if(this.get_$3().get_$8().length>2){$0=true;}else if(this.get_$3().get_$5().get_$6()){$0=true;}if($0){this.$15.$1_5();}},$7:function($p0,$p1){this.$16.add([$p0,$p1]);this.get_$3().$10(new MSCh._H$E(this,this.$15,$p0,$p1));},$6:function($p0,$p1){this.get_$3().$10(new MSCh._H$13(this,this.$15,$p0,$p1));},$12:function($p0){var $enum1=this.get_$3().get_$8().getEnumerator();while($enum1.moveNext()){var $0=$enum1.get_current();if($p0.address===$0.address){$p0.type=$0.type;break;}}if(this.get_$3().get_$8().length===2){this.get_$3().$E(new MSCh._H$15(this.$15,this.get_$3(),this.get_$4()));}this.get_$3().$13($p0);},$E:function($p0){for(var $0=0;$0<this.$16.length;$0++){var $1=this.$16[$0];var $2=$1[0];if(($2.address===$p0.address)&&($2.type===$p0.type)){this.$10(0,$p0,$1[1]);break;}}this.get_$3().$12($p0);},$10:function($p0,$p1,$p2){this.get_$3().$11($p0,$p1,$p2);},$11:function($p0){var $enum1=this.get_$3().get_$8().getEnumerator();while($enum1.moveNext()){var $0=$enum1.get_current();if($0.address===$p0.sender.address){$p0.sender.type=$0.type;break;}}this.get_$3().$14($p0);},$D:function(){this.get_$3().$E(new MSCh._H$16(this.get_$3(),this.get_$4()));}}
MSCh._H$11=function(conversation,events){MSCh._H$11.constructBase(this,[conversation,events]);this.$15=0;this.$16=[];this.$17=[];this.$18=this.get_$3().$A();}
MSCh._H$11.prototype={$15:0,$16:null,$17:null,$18:null,$19:null,$1A:false,$7:function($p0,$p1){this.$16.add([$p0,$p1]);},$6:function($p0,$p1){this.$17.add([$p0,$p1]);},$D:function(){this.$1C(500);},$1B:function($p0){var $0=this.$C($p0);if($p0.address===this.get_$3().get_$5().get_liveId()){this.$1A=true;if(!$0){this.get_$3().get_$8().add($p0);}}else{if(!$0){this.get_$3().$12($p0);}}if(this.$1A){if(this.$18){if(this.$18.type){this.$15=4;this.$1C(0);}}else{if(this.get_$3().get_$8().length>1){this.$15=4;this.$1C(0);}}}},$F:function($p0,$p1,$p2){this.$1B($p2);},$E:function($p0){this.$1B($p0);},$13:function($p0,$p1,$p2){this.$19=new MSCh._H$10($p0,this.get_$3());this.$19.$1_2(this.get_$3().get_$5().get_liveId(),this.get_$3().get_$5().get_localEndpoint(),$p2,$p1,Delegate.create(this,this.$1D));},$1C:function($p0){if($p0){this.$15=5;}if(this.$15===4){var $0=new MSCh._H$12(this.$19,this.get_$3(),this.get_$4());this.get_$3().$E($0);var $enum1=this.$16.getEnumerator();while($enum1.moveNext()){var $1=$enum1.get_current();$0.$7($1[0],$1[1]);}var $enum2=this.$17.getEnumerator();while($enum2.moveNext()){var $2=$enum2.get_current();$0.$6($2[0],$2[1]);}}else if(this.$15===5){var $3=new MSCh._H$16(this.get_$3(),this.get_$4());this.get_$3().$E($3);var $enum3=this.$16.getEnumerator();while($enum3.moveNext()){var $4=$enum3.get_current();this.get_$3().$11(1,$4[0],$4[1]);}var $enum4=this.$17.getEnumerator();while($enum4.moveNext()){var $5=$enum4.get_current();this.get_$3().$15($5[0],$5[1]);}}},$1D:function($p0,$p1){this.$15=3;this.$1C($p0);}}
MSCh._H$17=function(conversation,events){MSCh._H$17.constructBase(this,[conversation,events]);this.$16=0;this.$17=[];this.$18=[];}
MSCh._H$17.prototype={$15:null,$16:0,$17:null,$18:null,$19:0,$7:function($p0,$p1){this.$17.add([$p0,$p1]);},$6:function($p0,$p1){this.$18.add([$p0,$p1]);},$14:function(){this.get_$3().get_$5().requestMixerSession(Delegate.create(this,this.$1B));},$E:function($p0){var $0=this.$C($p0);if($p0.address===this.get_$3().get_$5().get_liveId()){this.$16=3;if(!$0){this.get_$3().get_$8().add($p0);}for(var $1=0;$1<this.get_$3().get_$8().length;$1++){var $2=this.get_$3().get_$8()[$1];if($2.address!==this.get_$3().get_$5().get_liveId()){this.$19++;this.$15.$1_3($2,Delegate.create(this,this.$1D));}}}else{this.$19--;if(!this.$19){this.$16=4;this.$1A(0);}}},$1A:function($p0){if($p0){this.$16=5;}if(this.$16===4){var $0=new MSCh._H$12(this.$15,this.get_$3(),this.get_$4());this.get_$3().$E($0);var $enum1=this.$17.getEnumerator();while($enum1.moveNext()){var $1=$enum1.get_current();$0.$7($1[0],$1[1]);}var $enum2=this.$18.getEnumerator();while($enum2.moveNext()){var $2=$enum2.get_current();$0.$6($2[0],$2[1]);}}else if(this.$16===5){var $3=new MSCh._H$16(this.get_$3(),this.get_$4());this.get_$3().$E($3);var $enum3=this.$17.getEnumerator();while($enum3.moveNext()){var $4=$enum3.get_current();this.get_$3().$11(1,$4[0],$4[1]);}var $enum4=this.$18.getEnumerator();while($enum4.moveNext()){var $5=$enum4.get_current();this.get_$3().$15($5[0],$5[1]);}}},$1B:function($p0,$p1){var $0=601;if(!$p0){this.$16=1;this.$15=new MSCh._H$10($p1[0],this.get_$3());this.$15.$1_6(this.get_$3().get_$5().get_liveId(),this.get_$3().get_$5().get_localEndpoint(),$p1[3],Delegate.create(this,this.$1C));$0=0;}this.$1A($0);},$1C:function($p0,$p1){if(!$p0){this.$16=2;var $0=MC.$create_IMAddressInfo(this.get_$3().get_$5().get_liveId(),1,0);this.$15.$1_3($0,Delegate.create(this,this.$1D));}this.$1A($p0);},$1D:function($p0,$p1){this.$1A($p0);}}
MSCh._H$16=function(conversation,events){MSCh._H$16.constructBase(this,[conversation,events]);}
MSCh._H$16.prototype={get_$2:function(){return false;},$7:function($p0,$p1){var $0=new MSCh._H$17(this.get_$3(),this.get_$4());this.get_$3().$E($0);$0.$7($p0,$p1);$0.$14();},$6:function($p0,$p1){var $0=new MSCh._H$17(this.get_$3(),this.get_$4());this.get_$3().$E($0);$0.$6($p0,$p1);$0.$14();},$13:function($p0,$p1,$p2){var $0=new MSCh._H$11(this.get_$3(),this.get_$4());this.get_$3().$E($0);$0.$13($p0,$p1,$p2);}}
MSCh._H$15=function(connection,conversation,events){MSCh._H$15.constructBase(this,[conversation,events]);this.$16=connection;this.$19=1;this.$17=[];this.$18=[];}
MSCh._H$15.prototype={$16:null,$17:null,$18:null,$19:0,$1A:null,get_$2:function(){return false;},$6:function($p0,$p1){this.$18.enqueue([$p0,$p1]);this.$1B();},$7:function($p0,$p1){this.$17.enqueue([$p0,$p1]);this.$1B();},$D:function(){this.$1E();},$E:function($p0){this.$1D();this.$C($p0);var $0=this.get_$3().$A();if(($0.address===$p0.address)&&($0.type===$p0.type)){this.$9($p0);}else{this.get_$3().$12($p0);}},$9:function($p0){this.$19=3;this.$1F(0);},$1B:function(){if(this.$19===1){this.$19=2;this.$1A=new MSCo.Timer(Delegate.create(this,this.$1C),null,30000,MSCo.Timeout.infinite);var $0=this.get_$3().$A();this.$16.$1_3($0,Delegate.create(this,this.$20));}},$1C:function($p0){this.$1E();},$1D:function(){if(this.$1A){this.$1A.dispose();this.$1A=null;}},$1E:function(){this.$1D();this.$19=4;this.$1F(0);},$1F:function($p0){if($p0){this.$19=4;}if(this.$19===2){}else if(this.$19===3){var $0=new MSCh._H$12(this.$16,this.get_$3(),this.get_$4());this.get_$3().$E($0);while(this.$17.length>0){var $1=this.$17.dequeue();$0.$7($1[0],$1[1]);}while(this.$18.length>0){var $2=this.$18.dequeue();$0.$6($2[0],$2[1]);}}else if(this.$19===4){var $3=new MSCh._H$16(this.get_$3(),this.get_$4());this.get_$3().$E($3);while(this.$17.length>0){var $4=this.$17.dequeue();this.get_$3().$11(1,$4[0],$4[1]);}while(this.$18.length>0){var $5=this.$18.dequeue();this.get_$3().$15($5[0],$5[1]);}}},$20:function($p0,$p1){this.$1F($p0);}}
MSCh._H$C=function(conversation,events){MSCh._H$C.constructBase(this,[conversation,events]);}
MSCh._H$C.prototype={get_$2:function(){return true;},$9:function($p0){this.get_$4().onConversationAddressJoined(this.get_$3().get_id(),$p0);},$A:function($p0){this.get_$4().onConversationAddressLeft(this.get_$3().get_id(),$p0);},$8:function($p0){this.get_$4().onConversationMessageReceived(this.get_$3().get_id(),$p0);},$B:function($p0,$p1){this.get_$4().onConversationSendMessageFailed(this.get_$3().get_id(),$p0,$p1);},$C:function($p0){if($p0.type){for(var $0=0;$0<this.get_$3().get_$8().length;$0++){var $1=this.get_$3().get_$8()[$0];if($1.address===$p0.address){$1.type=$p0.type;return true;}}}return false;},$D:function(){},$E:function($p0){},$F:function($p0,$p1,$p2){},$10:function($p0,$p1,$p2){},$11:function($p0){},$12:function($p0){},$13:function($p0,$p1,$p2){},$14:function(){}}
MSCh._H$D=function(conversation,events){MSCh._H$D.constructBase(this,[conversation,events]);conversation.get_$8().add(MC.$create_IMAddressInfo(conversation.get_$5().get_liveId(),1,0));}
MSCh._H$D.prototype={get_$2:function(){return true;},$6:function($p0,$p1){this.get_$3().$10(new MSCh._H$14(this,this.get_$3().get_$5(),this.get_$3().get_$8()[0],$p0,$p1));},$8:function($p0){if($p0.sender.type===32&&$p0.type===1){var $0=$p0.info;$0.text=MSCh._H$8.$9($0.text);}this.get_$4().onConversationMessageReceived(this.get_$3().get_id(),$p0);},$B:function($p0,$p1){this.get_$4().onConversationSendMessageFailed(this.get_$3().get_id(),$p0,$p1);}}
MSCh._H$8=function(){}
MSCh._H$8.$1=function($p0){switch($p0){case 1:return '1';case 255:return '2';case 2:return '3';default:return '0';}}
MSCh._H$8.$2=function($p0){var $0=new StringBuilder();switch($p0.type){case 1:$0.append(($p0.info).text);break;case 2:$0.append('ID: 1\r\n\r\n');break;case 3:$0.append(($p0.info).content);break;}return $0.toString();}
MSCh._H$8.$3=function($p0){var $0;$0=new StringBuilder();$0.append('MIME-Version: 1.0\r\nContent-Type: ');switch($p0.type){case 1:var $1=$p0.info;$0.append('text/plain; charset=UTF-8');if($1.format){$0.append('\r\nX-MMS-IM-Format: ');$0.append(MSCh._H$8.$5($1.format));}break;case 255:$0.append('text/x-msmsgscontrol\r\n');$0.append('TypingUser: ');$0.append(MSCh._H$6.$0($p0.sender.address));break;case 2:$0.append('text/x-msnmsgr-datacast');break;case 3:var $2=$p0.info;$0.append('application/x-msmsgr-webapp-message\r\n');$0.append('WebApp-Message-ID: ');$0.append($2.id);break;}return $0.toString();}
MSCh._H$8.$4=function($p0){var $0=MSCh._H$8.$3($p0);var $1=MSCh._H$8.$2($p0);var $2=MSCo.StringHelper.getByteCount($0)+4+MSCo.StringHelper.getByteCount($1);if($2<=1664){return [$0+'\r\n\r\n'+$1];}var $3=Math.ceil($1.length/400);var $4=new Array($3);var $5=MSCh._H$6.$7();var $6=new StringBuilder();for(var $7=0;$7<$3;$7++){$6.clear();var $8=MSCo.StringHelper.substring($1,$7*400,400);if(!$7){$6.append($0);$6.append('\r\nMessage-ID: ');$6.append($5);$6.append('\r\nChunks: ');$6.append($3);}else{$6.append('Message-ID: ');$6.append($5);$6.append('\r\nChunk: ');$6.append($7);}$6.append('\r\n\r\n');$6.append($8);$4[$7]=$6.toString();}return $4;}
MSCh._H$8.$5=function($p0){var $0=new StringBuilder();$0.append('FN=');$0.append(MSCh._H$6.$0($p0.fontFamily));$0.append('; EF=');if(($p0.fontStyle&1)>0){$0.append('B');}if(($p0.fontStyle&2)>0){$0.append('I');}if(($p0.fontStyle&4)>0){$0.append('S');}if(($p0.fontStyle&8)>0){$0.append('U');}var $1=MSCh._H$6.$5($p0.fontColor);$0.append('; CO=');$0.append(MSCh._H$6.$0($1));if($p0.rightToLeft){$0.append('; RL=1');}return $0.toString();}
MSCh._H$8.$6=function($p0,$p1){var $0=MSCo.StringHelper.splitChar($p1.getHeader('Content-Type'),';')[0];switch($0){case 'text/plain':if(String.isNullOrEmpty($p1.getBody())){return null;}var $1=null;var $2=$p1.getHeader('X-MMS-IM-Format');if(!String.isNullOrEmpty($2)){$1=MSCh._H$8.$7($2);}var $3=MC.$create_TextMessageInfo($p1.getBody(),$1);var $4=MC.$create_MessageInfo(1,$3);$4.sender=$p0;return $4;case 'text/x-msnmsgr-datacast':var $5=new MSM.MimeParser($p1.getBody());var $6=$5.getHeader('ID');if(String.isNullOrEmpty($6)||$6!=='1'){MSCo.LogHelper.logError('Chat.MessageHelper.ParseMessage','Unknown datacast type: '+$p1.getBody());return null;}var $7=MC.$create_MessageInfo(2,null);$7.sender=$p0;return $7;case 'text/x-msmsgscontrol':var $8=$p1.getHeader('TypingUser');if(String.isNullOrEmpty($8)||$8!==$p0.address){MSCo.LogHelper.logError('Chat.MessageHelper.ParseMessage','TypingUser header spoofed, ignoring.');return null;}var $9=MC.$create_MessageInfo(255,null);$9.sender=$p0;return $9;case 'application/x-msmsgr-webapp-message':var $A=$p1.getHeader('WebApp-Message-ID');if(String.isNullOrEmpty($A)){MSCo.LogHelper.logError('Chat.MessageHelper.ParseMessage','AppMessage does not have valid WebApp-Message-ID header');return null;}var $B=MC.$create_ApplicationMessageInfo(MSCo.StringHelper.toLowerCase($A),$p1.getBody());var $C=MC.$create_MessageInfo(3,$B);$C.sender=$p0;return $C;default:MSCo.LogHelper.logError('Chat.MessageHelper.ParseMessage','message type '+$0+' not supported');return null;}}
MSCh._H$8.$7=function($p0){var $0=String.Empty;var $1=0;var $2=0;var $3=false;var $4=$p0.split(';');var $enum1=$4.getEnumerator();while($enum1.moveNext()){var $5=$enum1.get_current();var $6=$5.split('=',2);if($6.length===2){var $7=$6[0].trim();var $8=MSCh._H$6.$3($6[1].trim());if($7==='FN'&&MSCh._H$6.$8($8)){$0=$8;}else if($7==='EF'){if($8.indexOf('B')>=0){$2|=1;}if($8.indexOf('I')>=0){$2|=2;}if($8.indexOf('U')>=0){$2|=8;}if($8.indexOf('S')>=0){$2|=4;}}else if($7==='CO'){$1=(MSCh._H$6.$6($8))&16777215;}else if($7==='RL'){$3=($8==='1');}}}return MC.$create_TextMessageFormatInfo($1,$0,$2,$3);}
MSCh._H$8.$9=function($p0){return $p0.replace(MSCh._H$8.$A,Delegate.create(null,function($p1_0){
return MSCh._H$8.$B($p1_0);}));}
MSCh._H$8.$B=function($p0){switch($p0){case ':-/':return ':S';case 'O:-)':return '(A)';case ':-&':return '+o(';case '(:|':return '|-)';case ':X':return '(L)';case '>:)':return '(6)';case 'X-(':return ':@';case ':((':return ':\'(';case ':-B':return '8-|';case ':-$':return ':-#';case ':\">':return ':$';case ':-?':return '*-)';case 'B-)':return '(H)';case ':-*':return '(K)';case '/:)':return '^o)';case '8-|':return '8-)';case '=((':return '(U)';case '<:-P':return '<:o)';default:return $p0;}}
MSCh._H$7=function(){}
MSCh._H$7.$0=function($p0,$p1,$p2){$p2=$p2||String.Empty;return new RegExp($p0,$p2).test($p1);}
MSCh._H$5=function(){}
MSCh._H$5.$1=function($p0){if(($p0.length%4)){throw new Error('invalid base64 length');}var $0=new StringBuilder();var $1=0;var $2=false;while($1<$p0.length){var $3=0;var $4=0;for(var $5=0;$5<4;$5++){$3<<=6;var $6=MSCo.StringHelper.charAt($p0,$1++);if($6!=='='){if($2){throw new Error('premature padding found');}var $7=MSCh._H$5.$0.indexOf($6);if($7<0){throw new Error('invalid bas64 data');}$3|=$7;$4+=6;}else{$2=true;}}$0.append(MSCo.StringHelper.fromCharCode(($3>>16)&255));if($4>=16){$0.append(MSCo.StringHelper.fromCharCode(($3>>8)&255));}if($4>=24){$0.append(MSCo.StringHelper.fromCharCode($3&255));}}return $0.toString();}
MSCh._H$6=function(){}
MSCh._H$6.$0=function($p0){$p0=$p0.replace(new RegExp('%','g'),'%25');$p0=$p0.replace(new RegExp(' ','g'),'%20');$p0=$p0.replace(new RegExp('\t','g'),'%09');$p0=$p0.replace(new RegExp('\r','g'),'%0D');$p0=$p0.replace(new RegExp('\n','g'),'%0A');return $p0;}
MSCh._H$6.$1=function($p0){return MSCh._H$6.$2($p0);}
MSCh._H$6.$2=function($p0){return parseInt($p0,10);}
MSCh._H$6.$3=function($p0){return decodeURIComponent($p0);}
MSCh._H$6.$4=function($p0){var $0=parseInt($p0,10);if(isNaN($0)){$0=-1;}return $0;}
MSCh._H$6.$5=function($p0){return $p0.toString(16);}
MSCh._H$6.$6=function($p0){var $0=parseInt($p0,16);if(isNaN($0)){$0=0;}return $0;}
MSCh._H$6.$7=function(){var $0=new Array(4);for(var $1=0;$1<4;$1++){$0[$1]=Math.round(Math.random()*16777215).toString(16).padLeft(8,'0');}return '{'+$0[0]+'-'+$0[1].substr(0,4)+'-'+$0[1].substr(4,4)+'-'+$0[2].substr(0,4)+'-'+$0[2].substr(4,4)+$0[3]+'}';}
MSCh._H$6.$8=function($p0){return !$p0.match(MSCh._H$6.$9);}
MSCh._H$B.createClass('MSCh._H$B');MSCh._H$A.createClass('MSCh._H$A',null,MSCh._H$1);MSCh.ConversationService.createClass('MSCh.ConversationService',null,MC.IConversationService,MC.IConversationEvents);MSCh._H$10.createClass('MSCh._H$10',MSM.MsnpConnection);MSCh._H$9.createClass('MSCh._H$9');MSCh._H$E.createClass('MSCh._H$E',MSCh._H$9);MSCh._H$F.createClass('MSCh._H$F',MSCh._H$9);MSCh._H$13.createClass('MSCh._H$13',MSCh._H$F);MSCh._H$14.createClass('MSCh._H$14',MSCh._H$F);MSCh._H$4.createClass('MSCh._H$4');MSCh._H$C.createClass('MSCh._H$C',MSCh._H$4);MSCh._H$12.createClass('MSCh._H$12',MSCh._H$C);MSCh._H$11.createClass('MSCh._H$11',MSCh._H$C);MSCh._H$17.createClass('MSCh._H$17',MSCh._H$C);MSCh._H$16.createClass('MSCh._H$16',MSCh._H$C);MSCh._H$15.createClass('MSCh._H$15',MSCh._H$C);MSCh._H$D.createClass('MSCh._H$D',MSCh._H$4);MSCh._H$8.createClass('MSCh._H$8');MSCh._H$7.createClass('MSCh._H$7');MSCh._H$5.createClass('MSCh._H$5');MSCh._H$6.createClass('MSCh._H$6');MSCh._H$8.$A=new RegExp(':-/|O:-\\)|:-&|\\(:\\||:X|>:\\)|X-\\(|:\\(\\(|:-B|:-\\$|:\">|:-\\?|B-\\)|:-\\*|/:\\)|8-\\||=\\(\\(|<:-P','ig');MSCh._H$5.$0='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';MSCh._H$6.$9=new RegExp('@|(expression)|\\(|\\\\','gi');
// ---- Do not remove this footer ----
// Generated using Script# v0.5.1.0 (http://projects.nikhilk.net)
// -----------------------------------
