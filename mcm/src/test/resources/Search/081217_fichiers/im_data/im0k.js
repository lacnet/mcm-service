MailIM.CWConversationWrapper=function MailIM_CWConversationWrapper$(a,b){this._answeringMachine=a;this._conversation=a.get_conversation();this.conversationWindow=b;this._typingChangeHandler=Delegate.create(this,this._typingChanged);this._conversation.get_typingAddresses().add_collectionChanged(this._typingChangeHandler);this._rosterChangeHandler=Delegate.create(this,this._reset);this._conversation.get_roster().add_collectionChanged(this._rosterChangeHandler);this._presenceChangeHandler=Delegate.create(this,this._presenceChanged);this._contactPresenceChangedHandler=Delegate.create(this,this._contactPresenceChanged);this._presenceMonitor=new MailIM.PropertyChangeMonitor(this._conversation.get_roster(),MailIM.PropertyChangeMonitor.CollectionType.conversation);this._presenceMonitor.add_propertyChanged(this._presenceChangeHandler);gWebIM.add_presenceChanged(this._contactPresenceChangedHandler);this._reset(null,null)};MailIM.CWConversationWrapper.prototype={thisIsACWConversationWrapper:true,_answeringMachine:null,_conversation:null,_self:null,isSelf:true,isYahoo:false,isAlias:false,isGroup:false,emailAddress:"",id:"",_rosterChangeHandler:null,_presenceChangeHandler:null,_contactPresenceChangedHandler:null,_presenceMonitor:null,conversationWindow:null,numberOfGroupContacts:0,_typingChangeHandler:null,_reset:function MailIM_CWConversationWrapper$_reset(n,m){var h=this._conversation.get_roster(),b=h.get_count(),j=b;if(b==3){var l="";for(var a=0;a<b;a++){var k=h.get_item(a).get_address();if(l.indexOf(k)==-1)l+=k;else{j--;break}}}var c=gWebIM.get_selfAddress();this._self=c;this.isSelf=true;this.isYahoo=c.get_type()==Microsoft.Live.Messenger.IMAddressType.yahoo;this.isAlias=c.get_type()==Microsoft.Live.Messenger.IMAddressType.smtp;this.isGroup=j>2;this.emailAddress=c.get_address();var i=false;this.numberOfGroupContacts=b-1;for(var a=0;a<b;a++){var d=h.get_item(a);if(!d.equals(c)){this.isSelf=false;if(d.get_type()==Microsoft.Live.Messenger.IMAddressType.yahoo)this.isYahoo=true;if(d.get_type()==3)this.isAlias=true;if(i==false){i=true;this.emailAddress=d.get_address()}}}this.id=gWebIM.get_chatManager().updateConversationId(this.id,this._conversation);var g={oldItems:null,newItems:null};this._presenceMonitor.collectionChangedUtility(m,g);var f=g.oldItems,e=g.newItems;if(f!=null)for(a=0;a<f.length;a++)this.conversationWindow.removeGroupContact(f[a]);if(e!=null)for(a=0;a<e.length;a++)this.conversationWindow.addGroupContact(e[a]);if(m!=null)this.conversationWindow.updatePresence()},_typingChanged:function MailIM_CWConversationWrapper$_typingChanged(d,c){var b={oldItems:null,newItems:null};this._presenceMonitor.collectionChangedUtility(c,b);var a=b.newItems;if(a!=null&&a.length>0)this.conversationWindow.typingChanged(a[0])},_getNonSelfImAddress:function MailIM_CWConversationWrapper$_getNonSelfImAddress(a){var b=this._conversation.get_roster(),d=b.get_count();if(a<0)a=0;else if(a>d)return null;var c=b.get_item(a);if(c.equals(this._self)){a++;return this._getNonSelfImAddress(a)}else return c},getImAddress:function MailIM_CWConversationWrapper$getImAddress(a){return this._getNonSelfImAddress(a>=0?a:0)},getKey:function MailIM_CWConversationWrapper$getKey(a){return a.get_address()+":"+a.get_type()},_presenceChanged:function MailIM_CWConversationWrapper$_presenceChanged(){this.conversationWindow.updatePresence()},_contactPresenceChanged:function MailIM_CWConversationWrapper$_contactPresenceChanged(b){var a=null,c=null;if(Microsoft.Live.Messenger.IMAddress.isInstance(b))a=b;else{c=b;a=c.get_currentAddress()}if(a){var d=this._conversation.get_roster();for(var e=d.get_count();e--;){var f=d.get_item(e);if(f.equals(a)&&!a.equals(gWebIM.get_selfAddress())){this.conversationWindow.updatePresence(a);break}}}},isThisOfType:function MailIM_CWConversationWrapper$isThisOfType(a){return a["thisIsACWConversationWrapper"]===true},isTextMessageValid:function MailIM_CWConversationWrapper$isTextMessageValid(a){if(this._conversation.supportsMessageType(Microsoft.Live.Messenger.MessageType.textMessage)&&this._conversation.isTextMessageValid(a))return true;return false},sendText:function MailIM_CWConversationWrapper$sendText(b){var a=new Microsoft.Live.Messenger.TextMessage(b,null);this._conversation.sendMessage(a)},supportsNudge:function MailIM_CWConversationWrapper$supportsNudge(){var a=this._conversation.supportsMessageType(Microsoft.Live.Messenger.MessageType.nudgeMessage);return a},sendNudge:function MailIM_CWConversationWrapper$sendNudge(){var a=new Microsoft.Live.Messenger.NudgeMessage;this._conversation.sendMessage(a)},notifyUserTyped:function MailIM_CWConversationWrapper$notifyUserTyped(){this._conversation.notifyUserTyped()},unWindMessagesAndsetupMessageHanders:function MailIM_CWConversationWrapper$unWindMessagesAndsetupMessageHanders(a,c){if(this._answeringMachine){var b;while((b=this._answeringMachine.shift())!=null)a.invoke(this._conversation,b);this._answeringMachine.stopListening();this._answeringMachine.dispose();this._answeringMachine=null}this._conversation.add_messageReceived(a);this._conversation.add_sendMessageFailed(c)},clearMessageHanders:function MailIM_CWConversationWrapper$clearMessageHanders(b,a){this._conversation.remove_messageReceived(b);this._conversation.remove_sendMessageFailed(a)},dispose:function MailIM_CWConversationWrapper$dispose(){gWebIM.remove_presenceChanged(this._contactPresenceChangedHandler);this._contactPresenceChangedHandler=null;this._presenceMonitor.remove_propertyChanged(this._presenceChangeHandler);this._presenceChangeHandler=null;this._presenceMonitor.dispose();this._presenceMonitor=null;this._conversation.get_roster().remove_collectionChanged(this._rosterChangeHandler);this._rosterChangeHandler=null;this._conversation.get_typingAddresses().remove_collectionChanged(this._typingChangeHandler);this._typingChangeHandler=null;this._self=null;this._conversation.close();this._conversation.dispose();this._conversation=null;this.conversationWindow=null}};MailIM.ConversationWindow=function MailIM_ConversationWindow$(k,i,h,g){MailIM.ConversationWindow.constructBase(this,[k,"MailIM.ConversationWindow"]);this.isPopOut=h;this.window=g;this.mainWindow=h?window:g;this._util=this.mainWindow.gCWUtilities;this._conversation=new MailIM.CWConversationWrapper(i,this);this._groupPersonalInfo=new Array(0);this._groupLastSeenOnline=new Array(0);this._groupLastUserState=new Array(0);this._onMessageReceivedHandler=Delegate.create(this,this.onMessageReceived);this._onSendMessageFailedHandler=Delegate.create(this,this.onSendMessageFailed);this._onUpdatePresenceHandler=Delegate.create(this,this.updatePresence);this._onTextboxPasteHandler=Delegate.create(this,this.onTextboxPaste);this._onTextboxAfterPasteHandler=Delegate.create(this,this.onTextboxAfterPaste);this._onTextboxKeyUpHandler=Delegate.create(this,this.onTextboxKeyUp);this._onTextboxKeyDownHandler=Delegate.create(this,this.onTextboxKeyDown);this._onTextboxMouseOverHandler=Delegate.create(this,this.onTextboxMouseOver);this._onTextboxMouseDownHandler=Delegate.create(this,this.onTextboxMouseDown);this._onSendButtonClickHandler=Delegate.create(this,this.onSendButtonClick);this._onSendButtonMouseDownHandler=Delegate.create(this,this.onSendButtonMouseDown);this._onSendButtonMouseUpHandler=Delegate.create(this,this.onSendButtonMouseUp);this._onSendButtonMouseOverHandler=Delegate.create(this,this.onSendButtonMouseOver);this._onSendButtonMouseOutHandler=Delegate.create(this,this.onSendButtonMouseOut);this._setFocusToTextboxHandler=Delegate.create(this,this._setFocusToTextbox);this._setStatusTextHandler=Delegate.create(this,this.setStatusText);this._flashState="Contact";this.attachControlToElement(this.attach);this.eTextbox.attachEvent(isIE()?"onpaste":"oninput",this._onTextboxPasteHandler);this.eTextbox.attachEvent("onkeyup",this._onTextboxKeyUpHandler);this.eTextbox.attachEvent("onkeydown",this._onTextboxKeyDownHandler);this.eTextbox.attachEvent("onmouseover",this._onTextboxMouseOverHandler);this.eTextbox.attachEvent("onmousedown",this._onTextboxMouseDownHandler);this.eSendButton.attachEvent("onclick",this._onSendButtonClickHandler);this.eSendButton.attachEvent("onmousedown",this._onSendButtonMouseDownHandler);this.eSendButton.attachEvent("onmouseup",this._onSendButtonMouseUpHandler);this.eSendButton.attachEvent("onmouseover",this._onSendButtonMouseOverHandler);this.eSendButton.attachEvent("onmouseout",this._onSendButtonMouseOutHandler);this.oToolbar=new MailIM.Toolbar(this.eToolbar);this.oToolbar.add_click(Delegate.create(this,this._toolbarOnClick));this.historyUpdater=new MailIM.HistoryUpdater(this.window,this.eHistory,this._conversation.getImAddress(0),this._conversation.id);this._statusStampManager=new MailIM.StatusStampManager(this.window);this._statusStampManager.onSetStatusText=Delegate.combine(this._statusStampManager.onSetStatusText,this._setStatusTextHandler);this._onFocusInHandler=Delegate.create(this,this._CW_onFocusIn);this._onFocusOutHandler=Delegate.create(this,this._CW_onFocusOut);this.Elt.attachEvent("onfocusin",this._onFocusInHandler);this.Elt.attachEvent("onfocusout",this._onFocusOutHandler);if(isIE6()){this.eConvo.anchor=new MailIM.Anchor(this.eConvo,null,this.window);this.eHistory.anchor=new MailIM.Anchor(this.eHistory,null,this.window);this.eUserMessage.anchor=new MailIM.Anchor(this.eUserMessage,null,this.window);this.eDisplayName.anchor=new MailIM.Anchor(this.eDisplayName,null,this.window);this.eDisplayNameNoEmoticons.anchor=new MailIM.Anchor(this.eDisplayNameNoEmoticons,null,this.window);this.ePsm.anchor=new MailIM.Anchor(this.ePsm,null,this.window)}var c=false,b=Microsoft.Live.Messenger.PresenceStatus.none,a={lastSeenOnline:true,_lastUserState:null,_lastSelfState:b,_wasBlocked:false};c=this.historyUpdater.restore(a);this._lastSeenOnline=a.lastSeenOnline;this._lastUserState=a._lastUserState;this._wasBlocked=a._wasBlocked;b=a._lastSelfState;if(!c)this._showWarningIfStranger();this._endisableNudge();this.updatePresence();if(this._conversation.isGroup){var j=this._conversation.numberOfGroupContacts;for(var e=0;e<j;e++)this.updateGroupContactPresence(this._conversation.getImAddress(e),MailIM.GroupInfo.Op.add,false);this.updateGroupUI()}if(!c){var d=null;if(this._conversation.isSelf)d=this._personalInfo.getNoticeIfSelfTalking();if(d)this.historyUpdater.addinfoPaneMsgToHistory(d,-1)}if(this._conversation.isSelf){var f=this._personalInfo.getNoticeForAppearingOffline(b);if(f)this.historyUpdater.addinfoPaneMsgToHistory(f,-1)}this.setStatusText("",null)};MailIM.ConversationWindow.prototype={_setStatusTextHandler:null,_statusStampManager:null,_personalInfo:null,_groupPersonalInfo:null,historyUpdater:null,userdata:null,_conversation:null,onPresenceUpdated:null,onStatusTextUpdated:null,onIncomingMessage:null,onBeforeNudge:null,window:null,mainWindow:null,isPopOut:false,eConvo:null,eTitle:null,ePawn:null,eDisplayName:null,eDisplayNameNoEmoticons:null,ePsm:null,eGroup:null,eInput:null,eToolbar:null,eStatusText:null,eTextbox:null,eSendButton:null,eFocusAnchor:null,eUserMessage:null,oToolbar:null,_isOfflineOrBlocked:false,_createdChatSession:null,_lastMessageInHistory:null,_onMessageReceivedHandler:null,_onSendMessageFailedHandler:null,_onUpdatePresenceHandler:null,_onTextboxPasteHandler:null,_onTextboxAfterPasteHandler:null,_onTextboxKeyUpHandler:null,_onTextboxKeyDownHandler:null,_onTextboxMouseOverHandler:null,_onTextboxMouseDownHandler:null,_onSendButtonClickHandler:null,_onSendButtonMouseDownHandler:null,_onSendButtonMouseUpHandler:null,_onSendButtonMouseOverHandler:null,_onSendButtonMouseOutHandler:null,_setFocusToTextboxHandler:null,_hasBeenPoppedOut:false,_onFocusInHandler:null,_onFocusOutHandler:null,_util:null,_lastUserState:null,_groupLastUserState:null,_lastSeenOnline:true,_groupLastSeenOnline:null,_poppedOutYouImgAlt:null,_poppedOutYouImg:null,_poppedOutYouImgCurrentUrl:null,_savedPsm:null,_wasBlocked:false,_textToSet:null,_cwHasFocus:true,_sendButtonDisabled:true,attach:function MailIM_ConversationWindow$attach(a){switch(a.id){case "send":this.eSendButton=a;break;case "cw_dnText":this.eDisplayName=a;break;case "cw_dnTextNoEmoticons":this.eDisplayNameNoEmoticons=a;break;case "cw_toolbar":this.eToolbar=a;break;case "cw_title":this.eTitle=a}switch(a.className){case "cw_mid":this.eConvo=a;break;case "cw_history":this.eHistory=a;break;case "cw_pawn":this.ePawn=a;break;case "cw_group":this.eGroup=a;break;case "cw_input":this.eInput=a;break;case "cw_psm":this.ePsm=a;break;case "cw_textbox":this.eTextbox=a;break;case "cw_usermessage":this.eUserMessage=a;break;case "cw_messageStatus":this.eStatusText=a;break;case "cw_focusAnchor":this.eFocusAnchor=a}return true},readyToConverse:function MailIM_ConversationWindow$readyToConverse(){this._conversation.unWindMessagesAndsetupMessageHanders(this._onMessageReceivedHandler,this._onSendMessageFailedHandler)},isGroup:function MailIM_ConversationWindow$isGroup(){return this._conversation.isGroup},getConversationId:function MailIM_ConversationWindow$getConversationId(){return this._conversation.id},updateGroupUI:function MailIM_ConversationWindow$updateGroupUI(){var a=new MailIM.GroupInfo(this._conversation);this.ePawn.src=a._pawnImageSrc;if(isIE6())gStatusImageMap.fixAlphaForIE6(this.ePawn,a._pawnImageSrc);this.ePawn.title=this.ePawn.alt=a._pawnImageTooltip;this.ePsm.innerHTML=a._psmInnerHTML;this.ePsm.title=a._psmTitleUnencoded;this.eDisplayName.innerHTML=a._dnInnerHTML;this.eDisplayName.title=a._chatTitleUnencoded;this.eDisplayNameNoEmoticons.innerHTML=a._dnInnerHTMLNoEmoticons;this.eDisplayNameNoEmoticons.title=a._chatTitleUnencoded;if(this.onPresenceUpdated!=null)this.onPresenceUpdated.invoke(a);if(this.isPopOut){this.window.document.title=a._chatTitleUnencoded;if(this._poppedOutYouImgAlt!=null)this._poppedOutYouImgAlt.alt=this._poppedOutYouImgAlt.title=a._displayPictureTooltip;if(this._poppedOutYouImg!=null)this._poppedOutYouImg.alt=this._poppedOutYouImg.title=a._displayPictureTooltip;if(this._poppedOutYouImg!=null&&this._poppedOutYouImgCurrentUrl!=gGroupPDP){this._poppedOutYouImg.setAttribute("src",gGroupPDP);this._poppedOutYouImgCurrentUrl=gGroupPDP}}this.oToolbar.disable("block");a.dispose();delete a},addGroupContact:function MailIM_ConversationWindow$addGroupContact(a){this.updateGroupContactPresence(a,MailIM.GroupInfo.Op.add,true)},removeGroupContact:function MailIM_ConversationWindow$removeGroupContact(a){this.updateGroupContactPresence(a,MailIM.GroupInfo.Op.del,true)},updateGroupContactPresence:function MailIM_ConversationWindow$updateGroupContactPresence(e,d,f){var b=this._conversation.getKey(e),a=new MailIM.PersonalInfo(e);this._groupPersonalInfo[b]=a;var c;if(d==MailIM.GroupInfo.Op.del){c=a.formatGroupMessage(d);this.addHrMessage("cw_historycontactDel",true,null,c,null);delete this._groupPersonalInfo[b];delete this._groupLastSeenOnline[b];delete this._groupLastUserState[b];if(f)if(this._conversation.isGroup)this.updateGroupUI();else this.updatePresence();return}if(d==MailIM.GroupInfo.Op.add){c=a.formatGroupMessage(d);this.addHrMessage("cw_historycontactAdd",!this.historyUpdater.lastMessageIsStrangerWarning,null,c,null);this._groupLastSeenOnline[b]=true;this._groupLastUserState[b]=null;this._endisableNudge()}if(a._isValidUserState){var g=this._groupLastSeenOnline[b];this._groupLastSeenOnline[b]=a._isOnline;if(a._msg!=null)if(a._isOnline&&!g||!a._isOnline)if(a._userState!=this._groupLastUserState[b]){this.historyUpdater.addinfoPaneMsgToHistory(a._msg,-1);this._groupLastUserState[b]=a._userState}}if(f)this.updateGroupUI()},_enDisableInputUI:function MailIM_ConversationWindow$_enDisableInputUI(){var a=false;if(!this._conversation.isGroup)a=this._personalInfo._blocked||this._personalInfo._isOffline;if(a!=this.isDisabled()){if(a){this.oToolbar.disable("emo");this.oToolbar.disable("nudge")}else{this.oToolbar.enable("emo");this._endisableNudge()}this.eTextbox.disabled=a;this._synchronizeSendButtonState();this.eTextbox.style.backgroundColor=a?"#E9E9E9":"white"}if(this._conversation.isGroup||this._conversation.isSelf||this._conversation.isAlias)this.oToolbar.disable("block");else this.oToolbar.enable("block")},updatePresence:function MailIM_ConversationWindow$updatePresence(b){if(b==null)b=this._conversation.getImAddress(0);if(this._conversation.isGroup){this.updateGroupContactPresence(b,MailIM.GroupInfo.Op.mod,true);return}var a=new MailIM.PersonalInfo(b,this._savedPsm);this._personalInfo=a;this._savedPsm=a._personalStatusMessage;var e=false;if(a._isValidUserState){var f=this._lastSeenOnline;this._lastSeenOnline=a._isOnline;this._isOfflineOrBlocked=a._isOfflineOrBlocked;if(a._msg!=null)if(a._isOnline&&!f||!a._isOnline)if(a._userState!=this._lastUserState){if(this.historyUpdater.wasLastMessageInfoPane)this.historyUpdater.replaceInfoPaneMsgToHistory(a._msg,a._userState);else this.historyUpdater.addinfoPaneMsgToHistory(a._msg,a._userState);this._lastUserState=a._userState;e=true}}if(this._groupPersonalInfo.length>0){this.updateGroupUI();return}this.ePawn.src=a._pawnImageSrc;if(isIE6())gStatusImageMap.fixAlphaForIE6(this.ePawn,a._pawnImageSrc);this.ePawn.title=this.ePawn.alt=a._pawnImageTooltip;this.ePsm.innerHTML=a._psmInnerHTML;this.ePsm.title=a._psmTitleUnencoded;this.eDisplayName.innerHTML=a._dnInnerHTML;this.eDisplayName.title=a._chatTitleUnencoded;this.eDisplayNameNoEmoticons.innerHTML=a._dnInnerHTMLNoEmoticons;this.eDisplayNameNoEmoticons.title=a._chatTitleUnencoded;if(a._isValidUserState){this._enDisableInputUI();if(this.onPresenceUpdated!=null)this.onPresenceUpdated.invoke(a);var d=this.oToolbar.getElement("block");if(a._blocked){if(!this._wasBlocked&&a._msg&&!e)this.historyUpdater.addinfoPaneMsgToHistory(a._msg,-1);this._wasBlocked=true;addCssClass(d,"ToolbarItemPressed");d.getElementsByTagName("IMG")[0].alt=gStrings.CW_Unblock_Tooltip}else{removeCssClass(d,"ToolbarItemPressed");if(this._wasBlocked){var g=this._personalInfo.getNoticeForUnblocking();this.historyUpdater.addinfoPaneMsgToHistory(g,-1);this._wasBlocked=false}d.getElementsByTagName("IMG")[0].alt=gStrings.CW_Block_Tooltip}if(this.isPopOut){this.window.document.title=a._chatTitleUnencoded;if(this._poppedOutYouImgAlt!=null)this._poppedOutYouImgAlt.alt=this._poppedOutYouImgAlt.title=a._displayPictureTooltip;if(this._poppedOutYouImg!=null)this._poppedOutYouImg.alt=this._poppedOutYouImg.title=a._displayPictureTooltip;var c=this._personalInfo.getDisplayUrl(this._conversation.getImAddress(0));if(this._poppedOutYouImg!=null&&this._poppedOutYouImgCurrentUrl!=c){this._poppedOutYouImg.setAttribute("src",c);this._poppedOutYouImg.setAttribute("attemptedsrc",c);this._poppedOutYouImgCurrentUrl=c}}}},_showWarningIfStranger:function MailIM_ConversationWindow$_showWarningIfStranger(){var a=true;if(a){this.addHrMessage("cw_historycontactStranger",this.historyUpdater._lastMessageInHistory!=null,true,gStrings.CW_CreditCardWarning,null);this.historyUpdater.lastMessageIsStrangerWarning=true}},setStatusText:function MailIM_ConversationWindow$setStatusText(a,b){this.eStatusText.innerHTML=a;if(this.onStatusTextUpdated!=null)this.onStatusTextUpdated.invoke(a,b)},_raiseOnIncomingMessage:function MailIM_ConversationWindow$_raiseOnIncomingMessage(c,b){var a=this.hasFocus();if(this.isPopOut&&!a&&!this.window.gCWHandler){this.window.gCWHandler=Delegate.create(this,this.Notify);this.window.gSharedInterval.registerCallback(this.window.gCWHandler)}if(this.onIncomingMessage)this.onIncomingMessage.invoke(this,{sender:c,message:b})},Notify:function MailIM_ConversationWindow$Notify(){var a;switch(this._flashState){case "Contact":a=this._conversation.emailAddress;this._flashState="NewMsg";break;case "NewMsg":a=gStrings.Notification_NewMessage;this._flashState=this.isPopOut?"Contact":"Product";break;case "Product":a=gStrings.PageTitleServiceName;this._flashState="Contact"}this.window.document.title=a;if(this.hasFocus()){this.ClearNotify();return false}return true},ClearNotify:function MailIM_ConversationWindow$ClearNotify(){if(this.isPopOut){this._flashState="Contact";this.window.document.title=this._conversation.emailAddress;this.window.gSharedInterval.unregisterCallback(this.window.gCWHandler);this.window.gCWHandler=null}else{this._flashState="Product";this.window.document.title=gStrings.PageTitleServiceName}},_getFriendlyName:function MailIM_ConversationWindow$_getFriendlyName(b){var c=b.get_presence(),d=b.get_address(),a=c?localizeFriendlyName(c.get_displayName()):"";if(a==""||a==null)a=d;return a},onMessageReceived:function MailIM_ConversationWindow$onMessageReceived(j,f){var b=f.get_message(),a=b.get_sender();if(!a)return;var e=false,g=gWebIM.findByIMAddress(a);if(g!=null)e=g.get_isBlocked();if(!e){this._enDisableInputUI();var h=a.get_address(),c=this._getFriendlyName(a),i=b.get_type(),d=null;switch(i){case Microsoft.Live.Messenger.MessageType.textMessage:this.historyUpdater.addToHistory(h,c,b.get_text(),b.get_format());d=b.get_timestamp();this.setStatusText("",null);this._raiseOnIncomingMessage(a,b);if(!this.hasFocus())playSound("type",this._util.isUserStatusDoNotDisturb());break;case Microsoft.Live.Messenger.MessageType.nudgeMessage:c=EmoticonReplacedHtml(c,this.historyUpdater.isYahooContact(a));this.doNudgeBehavior(c,a,f)}if(d!=null){this._statusStampManager.setLastMessageTimestamp(d);this._statusStampManager.setLastStatusTimestamp(null)}}},typingChanged:function MailIM_ConversationWindow$typingChanged(b){var a=this._getFriendlyName(b),d=String.format(gStrings.CW_Status_TypingIndicator,a);a=EmoticonReplacedHtml(a,this.historyUpdater.isYahooContact(b));var c=String.format(gStrings.CW_Status_TypingIndicator,a);this.setStatusText(c,d);var e=new Date;this._statusStampManager.setLastMessageTimestamp(e);this._statusStampManager.setTypeIndicatorStamp(new Date)},doNudgeBehavior:function MailIM_ConversationWindow$doNudgeBehavior(a,d,f){try{if(!a)if(this._conversation.supportsNudge())this._conversation.sendNudge();var b=gStrings.CW_Nudge_Sent;if(a)b=String.format(gStrings.CW_Nudge_Received,a);this.addHrMessage("cw_historyNudge",true,true,b,null);this.setStatusText("",null);if(a)this._raiseOnIncomingMessage(d,f);playSound("nudge",this._util.isUserStatusDoNotDisturb());var e={shakeWindow:true};if(e.shakeWindow&&(isIE()||this.window.outerHeight>100))for(var c=0;c<50;c++){this.window.moveBy(0,10);this.window.moveBy(10,0);this.window.moveBy(0,-10);this.window.moveBy(-10,0)}}catch(g){}},addHrMessage:function MailIM_ConversationWindow$addHrMessage(d,g,c,h,a){var f='<span class="'+d+' cw_historyerrorhr"><hr/></span>',j=g?f:'<div class="cw_padder"></div>',b;if(String.isNullOrEmpty(a)){a="";b=""}else{a="<br/>"+a;b="<br/>"}var e="";if(c!==null)e=String.format("<img class='cw_historyicon' src='{0}' alt=''{1}' title='{1}' />&nbsp;",getImage(c?"i_info.gif":"i_warn.gif",false),c?gStrings.InfoPane_Info_Tooltip:gStrings.InfoPane_Warning_Tooltip);var i=b+j+'<span class="'+d+'">'+e+h+a+"</span>"+f+b;this.historyUpdater.addinfoPaneMsgToHistoryNoMargin(i)},onSendMessageFailed:function MailIM_ConversationWindow$onSendMessageFailed(g,c){switch(c.get_resultCode()){case Microsoft.Live.Messenger.SendMessageResultCode.success:break;default:var b=c.get_message();if(b!=null&&b.get_type()==Microsoft.Live.Messenger.MessageType.textMessage){var f=c.get_resultCode(),d="";d=gStrings.WCLResultCode_UnexplainableError;var e=gStrings.CW_Send_Error+" "+d,a=b.get_text();a=a?htmlEncode(a).replace(/\n/,"<br/>"):"";this.addHrMessage("cw_historyerror",true,null,e,a)}}},_endisableNudge:function MailIM_ConversationWindow$_endisableNudge(){if(this._conversation.supportsNudge())this.oToolbar.enable("nudge");else this.oToolbar.disable("nudge")},selectConversation:function MailIM_ConversationWindow$selectConversation(){function a(a){a.cw.updatePresence();a.cw._setFocusToTextboxHandler()}if(this.isPopOut)CallFocus(this.window,a,{cw:this});else a({cw:this})},_setFocusToTextbox:function MailIM_ConversationWindow$_setFocusToTextbox(){if(!this.eTextbox.disabled)CallFocus(this.eTextbox);else CallFocus(this.eFocusAnchor)},_synchronizeSendButtonState:function MailIM_ConversationWindow$_synchronizeSendButtonState(){if(this.eTextbox.disabled||this.eTextbox.value==""){this.eSendButton.className=this.eSendButton.className.replace(/sendEnabled/g,"sendDisabled");this.eSendButton.disabled=true;this._sendButtonDisabled=true;this.eSendButton.title=""}else{if(this.eTextbox.value.length==1)this._conversation.notifyUserTyped();this.eSendButton.className=this.eSendButton.className.replace(/sendDisabled/g,"sendEnabled");this.eSendButton.disabled=false;this._sendButtonDisabled=false;this.eSendButton.title=gStrings.SendButton_Tooltip}},_getTextFromTextbox:function MailIM_ConversationWindow$_getTextFromTextbox(){var a=this.eTextbox.value;a=this._util.trimProperly(a);return a},isDisabled:function MailIM_ConversationWindow$isDisabled(){return this.eTextbox.disabled},onTextboxAfterPaste:function MailIM_ConversationWindow$onTextboxAfterPaste(){var a=this._getTextFromTextbox();if(a!=null&&a.length>400)this.eTextbox.value=a.substr(0,400);this._synchronizeSendButtonState()},onTextboxPaste:function MailIM_ConversationWindow$onTextboxPaste(){this.window.setTimeout(this._onTextboxAfterPasteHandler,10)},onTextboxMouseOver:function MailIM_ConversationWindow$onTextboxMouseOver(){this.window.setTimeout(this._onTextboxAfterPasteHandler,10)},onTextboxMouseDown:function MailIM_ConversationWindow$onTextboxMouseDown(){var b=this.window.gFocus.HasFocus,a=this._cwHasFocus;this.window.gFocus.HasFocus=true;this._CW_onFocusIn();if(!b||!a)this.ClearNotify()},resetIdleTime:function MailIM_ConversationWindow$resetIdleTime(){var a=gWebIM.get_inactiveAppTimer();if(a)a.resetTime()},_getEvt:function MailIM_ConversationWindow$_getEvt(a){if(!a)a=this.window.event;if(a==null||a.type.indexOf("key")==-1)a=null;return a},onTextboxKeyDown:function MailIM_ConversationWindow$onTextboxKeyDown(){var a=this.window.event;if(a.keyCode==13)if(!a.ctrlKey&&!a.shiftKey){var b=this._getTextFromTextbox();if(b.length>0)this._sendText(b);a.returnValue=false;if(this.window.eventData){this.window.eventData.handled=true;this.window.eventData.cancel=true}}this.onTextboxMouseDown()},onTextboxKeyUp:function MailIM_ConversationWindow$onTextboxKeyUp(a){a=this._getEvt(a);if(a==null)return;var c=this._getTextFromTextbox(),b=c.length;if(a.keyCode!=27)if(b>0){if(this._sendButtonDisabled){if(b==1)this._conversation.notifyUserTyped();this.eSendButton.className=this.eSendButton.className.replace(/sendDisabled/g,"sendEnabled");this.eSendButton.disabled=false;this._sendButtonDisabled=false;this.eSendButton.title=gStrings.SendButton_Tooltip}}else if(!this._sendButtonDisabled){this.eSendButton.className=this.eSendButton.className.replace(/sendEnabled/g,"sendDisabled");this.eSendButton.disabled=true;this._sendButtonDisabled=true;this.eSendButton.title=""}if(b>400)this.eTextbox.value=c.substr(0,400);return false},_sendText:function MailIM_ConversationWindow$_sendText(b){if(!String.isNullOrEmpty(b)){if(this._conversation.isTextMessageValid(b))this._conversation.sendText(b);var d=gWebIM.get_user(),a=localizeFriendlyName(d.get_presence().get_displayName()),c=gUser;if(a==""||a==null)a=c;this.historyUpdater.addToHistory(c,a,b);this.eTextbox.value="";this._synchronizeSendButtonState()}this._setFocusToTextboxHandler()},onSendButtonClick:function MailIM_ConversationWindow$onSendButtonClick(){var a=this._getTextFromTextbox();this._sendText(a);return false},onSendButtonMouseDown:function MailIM_ConversationWindow$onSendButtonMouseDown(){var a=this.eSendButton.className;a=a.replace(/sendHover/g,"sendNoHover");this.eSendButton.className=a.replace(/sendReleased/g,"sendPressed")},onSendButtonMouseUp:function MailIM_ConversationWindow$onSendButtonMouseUp(){var a=this.eSendButton.className;a=a.replace(/sendNoHover/g,"sendHover");this.eSendButton.className=a.replace(/sendPressed/g,"sendReleased")},onSendButtonMouseOver:function MailIM_ConversationWindow$onSendButtonMouseOver(){this.eSendButton.className=this.eSendButton.className.replace(/sendNoHover/g,"sendHover")},onSendButtonMouseOut:function MailIM_ConversationWindow$onSendButtonMouseOut(){this.eSendButton.className=this.eSendButton.className.replace(/sendHover/g,"sendNoHover")},initEmoMenu:function MailIM_ConversationWindow$initEmoMenu(b){var a=null;if(this._conversation.isYahoo){if(this.window.gEmoYMenuBody==null)this.window.gEmoYMenuBody=new MailIM.EmoticonMenuBody("EmoYMenu",b,this.window);a=this.window.gEmoYMenuBody}else{if(this.window.gEmoMenuBody==null)this.window.gEmoMenuBody=new MailIM.EmoticonMenuBody("EmoMenu",b,this.window);a=this.window.gEmoMenuBody}a.setCW(this);var c=a.getBody();return c},unInitEmoMenu:function MailIM_ConversationWindow$unInitEmoMenu(){UnInitEmoMenuBody(this.window)},_toolbarOnClick:function CW$ToolbarOnClick(h,c){cancelBubble(true,this.window);switch(c.menukey){case "emo":var g,d=this.isPopOut?"PopoutContainer":"MainContainer",b=this.initEmoMenu(d);if(b.isVisible())b.hide();else{function e(a){a.emoMenu.show(a.elem)}if(!this.eTextbox.disabled)CallFocus(this.eTextbox,e,{emoMenu:b,elem:c.elem})}break;case "nudge":this.doNudgeBehavior(null,null,null);break;case "block":var a=gWebIM.findByIMAddress(this._conversation.getImAddress(0));if(a){var f=a.get_isBlocked();if(f)a.allow();else a.block()}}},setPopOutImageElements:function MailIM_ConversationWindow$setPopOutImageElements(a,g,e,b){this._poppedOutYouImgAlt=g;this._poppedOutYouImg=a;if(!this._conversation.isGroup){var h=this._conversation.getImAddress(0),c=this._personalInfo.getDisplayUrl(h);a.setAttribute("src",c);var i=gWebIM.get_user(),f=this._personalInfo.getDisplayUrl(i);e.setAttribute("src",f);this._poppedOutYouImgCurrentUrl=c;a.setAttribute("attemptedsrc",c);e.setAttribute("attemptedsrc",f)}else{a.setAttribute("src",gGroupPDP);this._poppedOutYouImgCurrentUrl=gGroupPDP}this.updatePresence();if(!this._conversation.isGroup&&b&&this._personalInfo&&this._personalInfo._isFederated&&this._personalInfo._networkIconUrl){b.setAttribute("src",this._personalInfo._networkIconUrl);var d=b.parentNode;d.className=d.className.replace(/liveContactType/g,"federatedContactType")}},clearPopOutImageElements:function MailIM_ConversationWindow$clearPopOutImageElements(){this._poppedOutYouImgAlt=null;this._poppedOutYouImg=null;this._poppedOutYouImgCurrentUrl=null},onResize:function MailIM_ConversationWindow$OnResize(){if(isIE6()){this.eConvo.anchor.resize();this.eHistory.anchor.resize();this.eUserMessage.anchor.resize();this.eDisplayName.anchor.resize();this.eDisplayNameNoEmoticons.anchor.resize();this.ePsm.anchor.resize()}this.historyUpdater.bringIntoView()},close:function MailIM_ConversationWindow$close(b){if(this.isPopOut){var a=this.window;a.gPopoutWindow.closeout(b);a.close()}},_CW_onFocusIn:function CW$OnFocusIn(){if(!this._cwHasFocus){this._cwHasFocus=true;this.resetIdleTime()}},_CW_onFocusOut:function CW$OnFocusOut(a){var a=a?a:this.window.event;if(a&&!a.toElement||!this.Elt.contains(this.window.event.toElement))this._cwHasFocus=false},hasFocus:function cw$hasFocus(){var a=this._cwHasFocus;if(a){a=this.window.gFocus.HasFocus;if(a)if(!isIE()&&this.window.outerHeight<100)a=false}return a},dispose:function MailIM_ConversationWindow$dispose(){this.Elt.detachEvent("onfocusin",this._onFocusInHandler);this._onFocusInHandler=null;this.Elt.detachEvent("onfocusout",this._onFocusOutHandler);this._onFocusOutHandler=null;this.historyUpdater.save(this._lastSeenOnline,this._personalInfo?this._personalInfo._blocked:false);this.historyUpdater.dispose();this.historyUpdater=null;this._statusStampManager.onSetStatusText=Delegate.remove(this._statusStampManager.onSetStatusText,this._setStatusTextHandler);this._statusStampManager.dispose();this._statusStampManager=null;this.eTextbox.detachEvent(isIE()?"onpaste":"oninput",this._onTextboxPasteHandler);this.eTextbox.detachEvent("onkeyup",this._onTextboxKeyUpHandler);this.eTextbox.detachEvent("onkeydown",this._onTextboxKeyDownHandler);this.eTextbox.detachEvent("onmouseover",this._onTextboxMouseOverHandler);this.eSendButton.detachEvent("onclick",this._onSendButtonClickHandler);this.eSendButton.detachEvent("onmousedown",this._onSendButtonMouseDownHandler);this.eSendButton.detachEvent("onmouseup",this._onSendButtonMouseUpHandler);this.eSendButton.detachEvent("onmouseover",this._onSendButtonMouseOverHandler);this.eSendButton.detachEvent("onmouseout",this._onSendButtonMouseOutHandler);this._conversation.clearMessageHanders(this._onMessageReceivedHandler,this._onSendMessageFailedHandler);this._onMessageReceivedHandler=null;this._onSendMessageFailedHandler=null;this._onUpdatePresenceHandler=null;this._onTextboxPasteHandler=null;this._onTextboxAfterPasteHandler=null;this._onTextboxKeyUpHandler=null;this._onTextboxKeyDownHandler=null;this._onTextboxMouseOverHandler=null;this._onSendButtonClickHandler=null;this._onSendButtonMouseDownHandler=null;this._onSendButtonMouseUpHandler=null;this._onSendButtonMouseOverHandler=null;this._onSendButtonMouseOutHandler=null;this._setFocusToTextboxHandler=null;this._setStatusTextHandler=null;this._conversation.dispose();this._conversation=null;if(this.isPopOut){this.clearPopOutImageElements();this.unInitEmoMenu()}this.window=null;if(isIE6()){this.eConvo.anchor.dispose();this.eHistory.anchor.dispose();this.eUserMessage.anchor.dispose();this.eDisplayName.anchor.dispose();this.eDisplayNameNoEmoticons.anchor.dispose();this.ePsm.anchor.dispose();this.eConvo.anchor=null;this.eHistory.anchor=null;this.eUserMessage.anchor=null;this.eDisplayName.anchor=null;this.eDisplayNameNoEmoticons.anchor=null;this.ePsm.anchor=null}this.eConvo=null;this.eTitle=null;this.ePawn=null;this.eDisplayName=null;this.eDisplayNameNoEmoticons=null;this.ePsm=null;this.eGroup=null;this.eInput=null;this.eToolbar=null;this.eStatusText=null;this.eTextbox=null;this.eSendButton=null;this.eFocusAnchor=null;this.eUserMessage=null;this.userdata=null;for(var a=0;a<this._groupPersonalInfo.length;a++){var b=this._groupPersonalInfo[a];this._groupPersonalInfo[a]=null;b.dispose();delete b}if(this._personalInfo){this._personalInfo.dispose();delete this._personalInfo}delete this._groupPersonalInfo;delete this._groupLastSeenOnline;delete this._groupLastUserState;this._personalInfo=null;this._groupPersonalInfo=null;this._groupLastSeenOnline=null;this._groupLastUserState=null}};MailIM.ConversationWindow.createClass("MailIM.ConversationWindow",Control);MailIM.ToastManager=function MailIM_ToastManager$(){this._init()};MailIM.ToastManager.ChatMessageType=0;MailIM.ToastManager.NewSignInMessageType=1;MailIM.ToastManager.OtherMessageType=2;MailIM.ToastManager.prototype={_toastFull:null,_toastMini:null,_lastLocationCount:0,_init:function MailIM_ToastManager$_init(){this._toastFull=this._replicateIFrame(gToastFullModel,"IMToastFull");this._toastMini=this._replicateIFrame(gToastMiniModel,"IMToastMini")},_replicateIFrame:function MailIM_ToastManager$_replicateIFrame(c){try{var e=window.top.document,b=e.createElement("IFRAME");for(var a in c)if(a=="style")b.style.cssText=c[a];else if(a=="src")b.src=c[a];else b.setAttribute(a,c[a]);var d=e.getElementById("appDiv");if(d){d.appendChild(b);return b}}catch(f){}return null},_simpleErrorToast:function MailIM_ToastManager$_simpleErrorToast(b,a){try{if(this._toastFull){this._toastFull.contentWindow.create(gStrings.PageTitleServiceName,b,null,a);playSound("type",gCWUtilities.isUserStatusDoNotDisturb())}}catch(c){}},createToastForNewMessage:function MailIM_WebIM$createToastForNewMessage(h,c,f){if(this._toastFull){var e=c.get_presence(),a=null,d=c.get_type()===Microsoft.Live.Messenger.IMAddressType.yahoo;if(e)a=EmoticonReplacedHtml(e.get_displayName(),d);if(String.isNullOrEmpty(a))a=c.get_address();var g=f.get_type(),b="";if(g==Microsoft.Live.Messenger.MessageType.textMessage){b=f.get_text();b=gCWUtilities.prepareMessageTextForDisplay(b,d);a=a+" "+gStrings.CW_History_Says+":"}else if(g==Microsoft.Live.Messenger.MessageType.nudgeMessage){b=String.format(gStrings.CW_Nudge_Received,a);a=gStrings.Notification_NewMessage}try{this._toastFull.contentWindow.create(a,b,h,MailIM.ToastManager.ChatMessageType,false);playSound("type",gCWUtilities.isUserStatusDoNotDisturb())}catch(i){}}},newSignIn:function MailIM_ToastManager$newSignIn(){if(this._toastFull){var a=gWebIM.getSignedInLocationCount();if(a>1)this._simpleErrorToast(String.format(gStrings.NewSignIn,a),MailIM.ToastManager.NewSignInMessageType);this._lastLocationCount=a}},remotelySignedOut:function MailIM_ToastManager$remotelySignedOut(){if(this._toastFull){this.closeAll();if(this._lastLocationCount>=2)this._simpleErrorToast(gStrings.SignedOutFromElsewhere,MailIM.ToastManager.OtherMessageType);else window.alert(gStrings.WebIMGenericSignOutError)}},signInFailure:function MailIM_ToastManager$signInFailure(){if(this._toastFull)this._simpleErrorToast(gStrings.SignInFailure,MailIM.ToastManager.OtherMessageType)},clearToastsForChat:function MailIM_ToastManager$clearToastsForChat(a){if(this._toastFull)try{this._toastFull.contentWindow.clearToastsForChat(a)}catch(b){}},closeAll:function MailIM_ToastManager$closeAll(){try{if(this._toastFull)this._toastFull.contentWindow.closeAll();if(this._toastMini)this._toastMini.contentWindow.closeAll()}catch(a){}},dispose:function MailIM_ToastManager$dispose(){this.closeAll();this._toastFull=null;this._toastMini=null}};MailIM.BuddyListManager=function MailIM_BuddyListManager$(){this._init()};MailIM.BuddyListManager.prototype={_BuddyListIFrame:null,_BuddyListIFrameShadow:null,_BuddyListCollection:null,_instrumentationTypes:null,_gBuddyListContent:null,_gBuddyListItemTemplate:null,_init:function MailIM_BuddyListManager$_init(){this._BuddyListIFrameShadow=this._createDropShadow(gBuddyListDropShadowModel);this._BuddyListIFrame=this._createIFrame(gBuddyListModel);this._instrumentationTypes=Function;this._instrumentationTypes.CloseClicked=0;this._instrumentationTypes.BuddyClicked=1;this._instrumentationTypes.ViewOnlineContactsClicked=2;this._adjustBuddyListPosition()},_createIFrame:function MailIM_BuddyListManager$_createIFrame(c){try{var e=window.top.document,b=e.createElement("IFRAME");for(var a in c)if(a=="style")b.style.cssText=c[a];else if(a=="src")b.src=c[a];else b.setAttribute(a,c[a]);var d=e.getElementById("appDiv");if(d){var f=e.getElementById("IMFrame");if(d){d.insertBefore(b,f);return b}}}catch(g){}return null},_createDropShadow:function MailIM_BuddyListManager$_createDropShadow(e){try{var d=window.top.document,a=d.createElement("DIV");for(var b in e)if(b=="style")a.style.cssText=e[b];else a.setAttribute(b,e[b]);var c=d.getElementById("appDiv");if(c){var f=d.getElementById("IMFrame");if(c){c.insertBefore(a,f);return a}}}catch(g){}return null},_showBuddyList:function MailIM_BuddyListManager$_showBuddyList(){try{this._BuddyListIFrame.contentWindow.initialize(this);this._BuddyListIFrame.contentWindow.renderList();this._adjustBuddyListPosition();this._BuddyListIFrame.style.display="block";this._BuddyListIFrameShadow.style.display="block";this._BuddyListIFrame.focus();this._BuddyListIFrame.contentWindow.document.getElementById("Title").focus();this._sendInstrumentation(this._instrumentationTypes.ViewOnlineContactsClicked);setTimeout(this._BuddyListIFrame.contentWindow.attachEventHandler,0);return true}catch(a){}return false},_startChat:function MailIM_BuddyListManager$_startChat(a){try{gImClient.get_presenceManager().chat(a);return true}catch(b){}return false},_emoticonEncodeString:function MailIM_BuddyListManager$_emoticonEncodeString(a){try{return Microsoft.Live.Messenger.MessengerUtility.emoticonEncode(a)}catch(b){}return null},_redirectToNewMessage:function MailIM_BuddyListManager$_redirectToNewMessage(){this._hideBuddyList();var a=gCWUtilities.formatHotmailUrl("EditMessageLight.aspx");gImUI.navigateTo(a);return true},_hideBuddyList:function MailIM_BuddyListManager$_hideBuddyList(){this._BuddyListIFrame.style.display="none";this._BuddyListIFrameShadow.style.display="none";this._BuddyListIFrame.contentWindow.detachEventHandler()},_adjustBuddyListPosition:function MailIM_BuddyListManager$_adjustBuddyListPosition(){try{var l=getUiWindow(),b=l.document.getElementById("WebIMSeparator"),c=top.document.getElementById("IMBuddyList"),a=top.document.getElementById("IMBuddyListShadow"),k=this._getOffsetTop(b),f=k+b.offsetHeight;c.style.top=[f,"px"].join("");a.style.top=[f+5,"px"].join("");var g=this._getOffsetLeft(b),j=top.document.body.clientWidth,d=document.documentElement.dir=="rtl",i=d?"right":"left",h=d?"left":"right",e=d?g:j-g;c.style[i]="";c.style[h]=[e+3,"px"].join("");a.style[i]="";a.style[h]=[e,"px"].join("");return true}catch(m){}return false},_getOffsetTop:function MailIM_BuddyListManager$_getOffsetTop(b){offsetTop=b.offsetTop;var a=b.offsetParent;while(a!=null){offsetTop=offsetTop+a.offsetTop;a=a.offsetParent}return offsetTop},_getOffsetLeft:function MailIM_BuddyListManager$_getOffsetLeft(b){offsetLeft=b.offsetLeft;var a=b.offsetParent;while(a!=null){offsetLeft=offsetLeft+a.offsetLeft;a=a.offsetParent}return offsetLeft},_sendInstrumentation:function MailIM_BuddyListManager$_sendInstrumentation(a){if(a==this._instrumentationTypes.CloseClicked)sendInstrumentation(gStrings.PS_BuddyList_CloseClicked);else if(a==this._instrumentationTypes.BuddyClicked)sendInstrumentation(gStrings.PS_BuddyList_BuddyClicked);else if(a==this._instrumentationTypes.ViewOnlineContactsClicked)sendInstrumentation(gStrings.PS_BuddyList_ViewOnlineContactsClicked)},_getgUIFrame:function MailIM_BuddyListManager$_getgUIFrame(){return gUIFrame},_createNewBuddyListItem:function MailIM_BuddyListManager$_createNewBuddyListItem(h,g,b,j,i){var e="",c=gStatusTextMap.getItem(g),d=gStatusImageMap.getImageMap(g,i),a=[h," (",c,")"].join(""),f='style="visibility: hidden"';if(b!=null&&b!=""){f='style="visibility: visible"';a=[a," - ",b].join("")}a=a;e=String.format(this._gBuddyListItemTemplate.innerHTML,['id="',htmlQuoteEncode(j),'"'].join(""),['title="',htmlQuoteEncode(a),'"'].join(""),['src="',d,'"'].join(""),['title="',htmlQuoteEncode(c),'"'].join(""),d,this._emoticonEncodeString(h).innerHTML,c,f,this._emoticonEncodeString(b).innerHTML);this._gBuddyListContent.innerHTML=[this._gBuddyListContent.innerHTML,e].join("")},dispose:function MailIM_BuddyListManager$dispose(){this._hideBuddyList();this._BuddyListIFrame=null;this._BuddyListIFrameShadow=null;this._BuddyListCollection=null}};MailIM.AnsweringMachine=function MailIM_AnsweringMachine$(a){this._conversation=a;this._messages=[];this._onMessageReceivedHandler=Delegate.create(this,this._onMessageReceived);this._conversation.add_messageReceived(this._onMessageReceivedHandler)};MailIM.AnsweringMachine.prototype={_conversation:null,_onMessageReceivedHandler:null,_messages:null,__onNewMessage:null,add_onNewMessage:function MailIM_AnsweringMachine$add_onNewMessage(a){this.__onNewMessage=Delegate.combine(this.__onNewMessage,a)},remove_onNewMessage:function MailIM_AnsweringMachine$remove_onNewMessage(a){this.__onNewMessage=Delegate.remove(this.__onNewMessage,a)},_onMessageReceived:function MailIM_AnsweringMachine$_onMessageReceived(b,a){if(a!=null){this._messages.push(a);if(this.__onNewMessage)this.__onNewMessage(this,this._conversation)}},get_messageCount:function MailIM_AnsweringMachine$get_messageCount(){return this._messages.length},shift:function MailIM_AnsweringMachine$shift(){return this._messages.shift()},get_item:function MailIM_AnsweringMachine$get_item(a){if(a>=0&&a<this._messages.length)return this._messages[a];else return null},peek_message:function MailIM_AnsweringMachine$peek_message(){if(this._messages.length>0)return this._messages[this._messages.length-1];return null},get_conversation:function MailIM_AnsweringMachine$get_conversation(){return this._conversation},stopListening:function MailIM_AnsweringMachine$stopListening(){if(this._onMessageReceivedHandler){this._conversation.remove_messageReceived(this._onMessageReceivedHandler);this._onMessageReceivedHandler=null}},dispose:function MailIM_AnsweringMachine$dispose(){this.stopListening();for(var a=0;a<this._messages.length;a++)this._messages[a]=null;this._messages=null;this._conversation=null}};MailIM.PopOutData=function MailIM_PopOutData$(){};MailIM.PopOutData.prototype={name:null,window:null,hasWindow:false,id:null,isStarted:false,isForming:true,isCompleted:false,answeringMachine:null,inviter:null,startedHere:false,dispose:function MailIM_PopOutData$dispose(){this.name=null;this.window=null;this.hasWindow=false;this.id=null;this.isStarted=false;this.isForming=true;this.isCompleted=false;this.answeringMachine=null;this.inviter=null;this.startedHere=false}};MailIM.ChatManager=function MailIM_ChatManager$(){this._newConversationHandler=Delegate.create(this,this._newConversation);this._newMessageInAnsweringMachineHandler=Delegate.create(this,this._newMessageInAnsweringMachine);gWebIM.add_onNewConversation(this._newConversationHandler);this._popouts=new MailIM.PropertyBag;this._names=new MailIM.PropertyBag};MailIM.ChatManager.PopoutWindowName="cw_popout_window_name_prefix___";MailIM.ChatManager._url="http://"+window.location.hostname+"/im/pages/Popout.aspx";MailIM.ChatManager.prototype={_newConversationHandler:null,_newMessageInAnsweringMachineHandler:null,_presenceChangedHandler:null,_popOutInProcess:null,_popOutFailureHandler:null,_popouts:null,_names:null,__onIncomingChat:null,_answeringMachinesListenedTo:[],add_onIncomingChat:function MailIM_chatManager$add_onIncomingChat(a){this.__onIncomingChat=Delegate.combine(this.__onIncomingChat,a)},remove_onIncomingChat:function MailIM_chatManager$remove_onIncomingChat(a){this.__onIncomingChat=Delegate.remove(this.__onIncomingChat,a)},getConversationId:function MailIM_chatManager$getConversationId(c){var g="";if(c){var e=c.get_roster(),d=e.get_count(),h=gWebIM.get_selfAddress(),b=new Array(d);for(var a=0;a<d;a++){var f=e.get_item(a);b[a]=f.get_address()+"_"+f.get_type()}b.sort();g=b.join("__")}return g},updateConversationId:function MailIM_chatManager$updateConversationId(c,d){var a=null;if(d){a=this.getConversationId(d);if(c&&a!=c){var b=this._popouts.replaceIdInPropertyBag(c,a);if(b){b.id=a;if(b.name)this._names.setToPropertyBag(b.name,a)}}}return a},_getFutureConversationId:function MailIM_chatManager$_getFutureConversationId(b){var d="";if(b){var c=gWebIM.get_selfAddress(),a=new Array(2);a[0]=c.get_address()+"_"+c.get_type();a[1]=b.get_address()+"_"+b.get_type();a.sort();d=a.join("__")}return d},getIdForWindowName:function MailIM_ChatManager$getIdForWindowName(a){var b=this._names.getFromPropertyBag(a);return b},chat:function MailIM_ChatManager$chat(i,k){var h=gWebIM.findContact(k,i);if(h!=null){var g=h.get_currentAddress(),b=this._getFutureConversationId(g),a=this._popouts.getFromPropertyBag(b);if(a)try{if(a.window&&a.window.gPopoutWindow)a.window.gPopoutWindow.selectConversation();else if(!a.isForming){this.popOut(b);sendInstrumentation(gStrings.PS_ChatOut)}}catch(l){}else{var a=this.popOut(b);if(a){a.inviter=gWebIM.get_selfAddress();a.startedHere=true;var c=null,d=gWebIM.get_user().get_conversations();if(d){var f=d.getEnumerator();while(f.moveNext()){var e=f.get_current(),j=this.getConversationId(e);if(j==b){c=e;break}}}if(!c)gWebIM.startConversation(g);else this._newConversation(c);sendInstrumentation(gStrings.PS_ChatOut)}}}},respondToChat:function MailIM_ChatManager$respondToChat(a){this.popOut(a);sendInstrumentation(gStrings.PS_RespondToChat)},_newConversation:function MailIM_ChatManager$_newConversation(c){var a=new MailIM.AnsweringMachine(c),d=this.getConversationId(c),b=this._popouts.getFromPropertyBag(d);if(b){b.answeringMachine=a;this._connectConversation(b)}else{a.add_onNewMessage(this._newMessageInAnsweringMachineHandler);this._answeringMachinesListenedTo.push(a)}},_newMessageInAnsweringMachine:function MailIM_ChatManager$_newMessageInAnsweringMachine(d,f){var e=d.peek_message().get_message(),b=e.get_sender();if(!b||b.equals(gWebIM.get_selfAddress()))return;var c=this.getConversationId(f),a=this._popouts.getFromPropertyBag(c);if(!a){var a=new MailIM.PopOutData;a.id=c;a.answeringMachine=d;a.inviter=b;a.startedHere=false;a.isForming=false;this._popouts.setToPropertyBag(c,a)}if(this.__onIncomingChat)this.__onIncomingChat(c,b,e)},_connectConversation:function MailIM_ChatManager$_connectConversation(a){if(a.isCompleted&&a.answeringMachine&&a.hasWindow){a.answeringMachine.remove_onNewMessage(this._newMessageInAnsweringMachineHandler);var b=-1;for(var c=this._answeringMachinesListenedTo.length;c--;)if(this._answeringMachinesListenedTo[c]===a.answeringMachine){b=c;break}if(b!=-1)this._answeringMachinesListenedTo.splice(b,1);try{a.window.gPopoutWindow.setupConversation(a.answeringMachine)}catch(d){}a.answeringMachine=null}},setupPopoutWindowName:function MailIM_ChatManager$setupPopoutWindowName(c){var d=new Date,b="r"+Math.floor(Math.random()*1e4)+d.valueOf(),a=MailIM.ChatManager.PopoutWindowName+b;this._names.setToPropertyBag(a,c);return a},popOut:function MailIM_ChatManager$popOut(b){try{this._popOutInProcess=b;var c=this.setupPopoutWindowName(b),a=this._popouts.getFromPropertyBag(b);if(!a){a=new MailIM.PopOutData;a.id=b;this._popouts.setToPropertyBag(b,a)}var d="toolbar=0,scrollbars=0,location=0,statusbar=1,menubar=0,resizable=1,width=485,height=521,target=_blank";if(this._popOutFailureHandler==null)this._popOutFailureHandler=Delegate.create(this,this._popOutFailure);this._popoutFailureTimer=window.setTimeout(this._popOutFailureHandler,3e4);a.name=c;var e=window.open(MailIM.ChatManager._url,c,d);a.window=e;a.hasWindow=true;a.isForming=false;a.isStarted=true;return a}catch(f){this._popOutFailure();return null}},popOutComplete:function MailIM_ChatManager$popOutComplete(c,b){this._popOutInProcess=null;if(this._popoutFailureTimer){window.clearTimeout(this._popoutFailureTimer);this._popoutFailureTimer=0}var a=this._popouts.getFromPropertyBag(b);if(a){a.isCompleted=true;this._connectConversation(a);gToastManager.clearToastsForChat(b)}},hasOpenConversations:function MailIM_ChatManager$hasOpenConversations(){var a=this._names.isEmpty()==false;return a},_popOutFailure:function MailIM_ChatManager$_popOutFailure(){if(this._popOutInProcess){this._popoutFailureTimer=0;this.closeConversation(this._popOutInProcess);this._popOutInProcess=null;alert(gStrings.PopoutFailure)}},closeConversation:function MailIM_ChatManager$closeConversation(b,c){var a=this._popouts.getFromPropertyBag(b);if(a){if(c)this._popouts.clearFromPropertyBag(b);else this._popouts.setToPropertyBag(b,null);if(a.name)this._names.clearFromPropertyBag(a.name);a.dispose()}},_closeoutTheKey:function ImClient_Client$_closeoutTheKey(c,d){if(c.indexOf(MailIM.ImClient.WindowName)==-1){var a=d;if(a)try{var b=a.window;if(b){b.gPopoutWindow.closeout(true);b.close()}else{if(a.name)this._names.clearFromPropertyBag(a.name);a.dispose();this._popouts.setToPropertyBag(c,null)}}catch(e){}}},closeAll:function ImClient_Client$closeAll(){var a=Delegate.create(this,this._closeoutTheKey);this._popouts.every(a);this._popouts.debugCheckifAllNull()},dispose:function MailIM_ChatManager$dispose(){gWebIM.remove_onNewConversation(this._newConversationHandler);this._newConversationHandler=null;var b=this._answeringMachinesListenedTo.length;for(var a=b;a--;)if(this._answeringMachinesListenedTo[a]!=null){this._answeringMachinesListenedTo[a].remove_onNewMessage(this._newMessageInAnsweringMachineHandler);this._answeringMachinesListenedTo[a]=null}if(b>0)this._answeringMachinesListenedTo.splice(0,b);this._newMessageInAnsweringMachineHandler=null;this._popOutFailureHandler=null;this._popouts.debugCheckifAllNull();this._popouts.dispose();this._popouts=null;this._names.dispose();this._names=null}}