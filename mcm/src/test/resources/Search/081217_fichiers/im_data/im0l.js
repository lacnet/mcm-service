MailIM.WebIMIdentity=function MailIM_WebIMIdentity$(a){MailIM.WebIMIdentity.constructBase(this);this._liveId=a};MailIM.WebIMIdentity.prototype={_liveId:null,get_liveId:function MailIM_WebIMIdentity$get_liveId(){return this._liveId},get_cid:function MailIM_WebIMIdentity$get_cid(){return gCid}};MailIM.WebIMIdentity.createClass("MailIM.WebIMIdentity",Microsoft.Live.Core.Identity);var gSharedInterval=null,gFocus=null;MailIM.WebIM=function MailIM_WebIM$(){MailIM.WebIM.constructBase(this);this._signInCompletedHandler=Delegate.create(this,this._signInCompleted);this._signOutCompletedHandler=Delegate.create(this,this._signOutCompleted);this._signedOutRemotelyHandler=Delegate.create(this,this._signedOutRemotely);this._myPresenceChangedHandler=Delegate.create(this,this._myPresenceChanged);this._newSignInOutHandler=Delegate.create(this,this._newSignInOut);this._conversationsChangedHandler=Delegate.create(this,this._conversationsChanged);this._onIncomingChatHandler=Delegate.create(this,this._onIncomingChat);this._onEmailReceivedHandler=Delegate.create(this,this._onEmailReceived);this._inactiveTimer=new MailIM.InactiveTimer(-1);this._inactiveStatusChangedHandler=Delegate.create(this,this._onInactiveStatus);this._activeStatusChangedHandler=Delegate.create(this,this._onActiveStatus);this._inactiveTimer.add_inactiveStatus(this._inactiveStatusChangedHandler);this._inactiveTimer.add_activeStatus(this._activeStatusChangedHandler);gsharedInterval=new MailIM.SharedInterval(window,1e3);gFocus=new MailIM.WindowFocus(window)};MailIM.WebIM.prototype={_user:null,_signInCompletedHandler:null,_signOutCompletedHandler:null,_signedOutRemotelyHandler:null,_conversationsChangedHandler:null,_onIncomingChatHandler:null,_myPresenceChangedHandler:null,_newSignInOutHandler:null,_presenceChangeHandler:null,_presenceMonitor:null,_chatManager:null,_inactiveTimer:null,__signInCompleted:null,__signOutCompleted:null,_signedOutRemotely:null,__onNewConversation:null,__presenceChanged:null,__onIncomingChat:null,__newSignInOut:null,_signedIn:false,_isStateSetByInactiveTimer:false,_inactiveStatusChangedHandler:null,_activeStatusChangedHandler:null,_onEmailReceivedHandler:null,__emailReceived:null,add_emailReceived:function MailIM_WebIM$add_emailReceived(a){this.__emailReceived=Delegate.combine(this.__emailReceived,a)},remove_emailReceived:function MailIM_WebIM$remove_emailReceived(a){this.__emailReceived=Delegate.remove(this.__emailReceived,a)},add_signInCompleted:function MailIM_WebIM$add_signInCompleted(a){this.__signInCompleted=Delegate.combine(this.__signInCompleted,a)},remove_signInCompleted:function MailIM_WebIM$remove_signInCompleted(a){this.__signInCompleted=Delegate.remove(this.__signInCompleted,a)},add_signOutCompleted:function MailIM_WebIM$add_signOutCompleted(a){this.__signOutCompleted=Delegate.combine(this.__signOutCompleted,a)},remove_signOutCompleted:function MailIM_WebIM$remove_signOutCompleted(a){this.__signOutCompleted=Delegate.remove(this.__signOutCompleted,a)},add_onNewConversation:function MailIM_WebIM$add_onNewConversation(a){this.__onNewConversation=Delegate.combine(this.__onNewConversation,a)},remove_onNewConversation:function MailIM_WebIM$remove_onNewConversation(a){this.__onNewConversation=Delegate.remove(this.__onNewConversation,a)},add_presenceChanged:function MailIM_WebIM$add_presenceChanged(a){this.__presenceChanged=Delegate.combine(this.__presenceChanged,a)},remove_presenceChanged:function MailIM_WebIM$remove_presenceChanged(a){this.__presenceChanged=Delegate.remove(this.__presenceChanged,a)},add_onIncomingChat:function MailIM_WebIM$add_onIncomingChat(a){this.__onIncomingChat=Delegate.combine(this.__onIncomingChat,a)},remove_onIncomingChat:function MailIM_WebIM$remove_onIncomingChat(a){this.__onIncomingChat=Delegate.remove(this.__onIncomingChat,a)},add_newSignInOut:function MailIM_WebIM$add_newSignInOut(a){this.__newSignInOut=Delegate.combine(this.__newSignInOut,a)},remove_newSignInOut:function MailIM_WebIM$remove_newSignInOut(a){this.__newSignInOut=Delegate.remove(this.__newSignInOut,a)},get_user:function MailIM_WebIM$get_user(){return this._user},get_selfAddress:function MailIM_WebIM$get_selfAddress(){return this._user?this._user.get_address():null},_signInCompleted:function MailIM_WebIM$_signInCompleted(b,a){if(a.get_resultCode()==Microsoft.Live.Messenger.SignInResultCode.success){this._signedIn=true;this._user.get_localEndpoint().set_name("Hotmail");this._presenceChangeHandler=Delegate.create(this,this._presenceChanged);this._presenceMonitor=new MailIM.PropertyChangeMonitor(this._user.get_contacts(),MailIM.PropertyChangeMonitor.CollectionType.contacts);this._chatManager=new MailIM.ChatManager;this._chatManager.add_onIncomingChat(this._onIncomingChatHandler);this._presenceMonitor.add_propertyChanged(this._presenceChangeHandler);this._user.get_presence().add_propertyChanged(this._myPresenceChangedHandler);this._user.get_endpoints().add_collectionChanged(this._newSignInOutHandler);this._user.get_mailbox().add_emailReceived(this._onEmailReceivedHandler)}else sendInstrumentation(gStrings.PS_SignInFailure);if(this.__signInCompleted)this.__signInCompleted.invoke(this._signedIn)},isSignedIn:function MailIM_WebIM$isSignedIn(){return this._signedIn},_conversationsChanged:function MailIM_WebIM$_conversationsChanged(c,a){if(a.get_action()==Microsoft.Live.Core.NotifyCollectionChangedAction.add){var b=a.get_newItems()[0];if(this.__onNewConversation)this.__onNewConversation(b)}},signIn:function MailIM_WebIM$signIn(b,c){var a=new MailIM.WebIMIdentity(b);this._user=new Microsoft.Live.Messenger.User(a);this._user.add_signInCompleted(this._signInCompletedHandler);this._user.add_signOutCompleted(this._signOutCompletedHandler);this._user.add_signedOutRemotely(this._signedOutRemotelyHandler);this._user.get_conversations().add_collectionChanged(this._conversationsChangedHandler);this._user.get_presence().set_status(c);this._user.signIn(null);sendInstrumentation(gStrings.PS_SignIn)},startConversation:function MailIM_WebIM$startConversation(a){this._user.get_conversations().create(a)},findContact:function MailIM_WebIM$findContact(a,c){a=a&&a.indexOf("cid:")==0?a.substr(4):a;if(!String.isNullOrEmpty(a)&&a!=0){var f=this._user.get_contacts().getEnumerator();while(f.moveNext()){var e=f.get_current(),d=e.get_addresses().getEnumerator();while(d.moveNext()){var g=d.get_current(),h=g.get_cid();if(h==a)return e}}}var b=null;if(!String.isNullOrEmpty(c)){b=this._user.get_contacts().find(c,Microsoft.Live.Messenger.IMAddressType.yahoo);if(b==null)b=this._user.get_contacts().find(c,Microsoft.Live.Messenger.IMAddressType.officeCommunicator);if(b==null)b=this._user.get_contacts().find(c,Microsoft.Live.Messenger.IMAddressType.windowsLive)}return b},findByIMAddress:function MailIM_WebIM$findByIMAddress(a){return this._user.get_contacts().findByAddress(a)},_presenceChanged:function MailIM_WebIM$_presenceChanged(b){if(this.__presenceChanged){var a=null;if(Microsoft.Live.Messenger.IMAddress.isInstance(b))a=this.findByIMAddress(b);this.__presenceChanged(a?a:b)}},_myPresenceChanged:function MailIM_WebIM$_myPresenceChanged(){if(this.__presenceChanged){var a=this._user.get_address(),b=this.findByIMAddress(a);this.__presenceChanged(b?b:a)}},changeStatus:function MailIM_WebIM$changeStatus(b){var a=Microsoft.Live.Messenger.PresenceStatus.online;try{a=Enum.parse(Microsoft.Live.Messenger.PresenceStatus,b)}catch(c){return a}this._user.get_presence().set_status(a);this._isStateSetByInactiveTimer=false;return a},_signedOutRemotely:function MailIM_WebIM$_signOutCompleted(){this._handleSignOut(true)},_signOutCompleted:function MailIM_WebIM$_signOutCompleted(){this._handleSignOut(false)},_markSignout:function MailIM_WebIM$_markSignout(){if(this._chatManager)this._chatManager.closeAll();this._signedIn=false},_handleSignOut:function MailIM_WebIM$_handleSignOut(a){this._markSignout();if(this._user){this._user.remove_signInCompleted(this._signInCompletedHandler);this._user.remove_signOutCompleted(this._signOutCompletedHandler);this._user.get_conversations().remove_collectionChanged(this._conversationsChangedHandler);this._user.get_presence().remove_propertyChanged(this._myPresenceChangedHandler);this._user.get_endpoints().remove_collectionChanged(this._newSignInOutHandler);this._user=null}if(this._presenceMonitor){this._presenceMonitor.remove_propertyChanged(this._presenceChangeHandler);this._presenceMonitor.dispose();this._presenceMonitor=null}if(this._chatManager){this._chatManager.remove_onIncomingChat(this._onIncomingChatHandler);this._chatManager.dispose();this._chatManager=null}if(this.__signOutCompleted)this.__signOutCompleted.invoke(a)},_onIncomingChat:function MailIM_WebIM$_onIncomingChat(c,a,b){if(this.__onIncomingChat)this.__onIncomingChat(c,a,b)},_onEmailReceived:function MailIM_WebIM$_onEmailReceived(c,a){if(this.__emailReceived){var b={folder:a.get_folder(),sender:a.get_messageUrl(),senderAddress:a.get_senderAddress(),subject:a.get_subject()};this.__emailReceived.invoke(b)}},_newSignInOut:function MailIM_WebIM$_newSignInOut(b,a){if(a.get_action()==Microsoft.Live.Core.NotifyCollectionChangedAction.add){if(this.__newSignInOut)this.__newSignInOut(true)}else if(a.get_action()==Microsoft.Live.Core.NotifyCollectionChangedAction.remove)if(this.__newSignInOut)this.__newSignInOut(false)},_onInactiveStatus:function MailIM_WebIM$onInactiveStatus(){if(this._user&&this._user.get_presence().get_status()===Microsoft.Live.Messenger.PresenceStatus.online){this._user.get_presence().set_status(Microsoft.Live.Messenger.PresenceStatus.away);this._isStateSetByInactiveTimer=true}},_onActiveStatus:function MailIM_WebIM$onActiveStatus(){if(this._user&&this._isStateSetByInactiveTimer)this._user.get_presence().set_status(Microsoft.Live.Messenger.PresenceStatus.online)},getSignedInLocationCount:function MailIM_WebIM$getSignedInLocationCount(){var a=0;if(this._user&&this._signedIn)a=this._user.get_endpoints().get_count();return a},signOut:function MailIM_WebIM$signOut(a){if(this._user&&this._signedIn){this._markSignout();this._user.signOut(a?Microsoft.Live.Messenger.SignOutLocations.all:Microsoft.Live.Messenger.SignOutLocations.local,null)}},get_chatManager:function MailIM_WebIM$get_chatManager(){return this._chatManager},get_inactiveAppTimer:function MailIM_WebIM$get_inactiveAppTimer(){return this._inactiveTimer},format:function MailIM_WebIM$format(){return String.format(arguments)},createDelegate:function MailIM_WebIM$createDelegate(b,a){return Delegate.create(b,a)},dispose:function MailIM_WebIM$dispose(){this.signOut();this._signOutCompleted(null,null);this._inactiveTimer.remove_inactiveStatus(this._inactiveStatusChangedHandler);this._inactiveTimer.remove_activeStatus(this._activeStatusChangedHandler);this._inactiveStatusChangedHandler=null;this._activeStatusChangedHandler=null;this._inactiveTimer.dispose();this._inactiveTimer=null;this._signInCompletedHandler=null;this._signOutCompletedHandler=null;this._conversationsChangedHandler=null;this._onIncomingChatHandler=null;this._presenceChangeHandler=null;this._myPresenceChangedHandler=null;this._newSignInOutHandler=null;this.__onNewConversation=null;this.__signInCompleted=null;this.__signOutCompleted=null;this._onEmailReceivedHandler=null;this.__emailReceived=null}};MailIM.WebIM.createClass("MailIM.WebIM",null,IDisposable);var PresenceManager=function PresenceManager$(){};PresenceManager.ActiveXStatus=function PresenceManager_ActiveXStatus(){};PresenceManager.ActiveXStatus.offline=1;PresenceManager.ActiveXStatus.online=2;PresenceManager.ActiveXStatus.busy=10;PresenceManager.ActiveXStatus.appearOffline=6;PresenceManager.ActiveXStatus.beRightBack=14;PresenceManager.ActiveXStatus.idle=18;PresenceManager.ActiveXStatus.away=34;PresenceManager.ActiveXStatus.inACall=50;PresenceManager.ActiveXStatus.outToLunch=66;PresenceManager.ActiveXStatus.prototype={offline:1,online:2,busy:10,appearOffline:6,beRightBack:14,idle:18,away:34,inACall:50,outToLunch:66};var gActivexStatusLookup=new PresenceManager.ActiveXStatus;PresenceManager.PresenceInfo=function ImClient_PresenceInfo$(){};PresenceManager.PresenceInfo.prototype={source:null,cid:null,emailAddress:null,displayName:null,psm:null,displayUrl:null,status:0,isBlocked:false,isSelf:false,webimStatus:Microsoft.Live.Messenger.PresenceStatus.prototype.none,state:null};PresenceManager.Subscription=function PresenceManager_Subscription$(d,c,b,a,e){this.uiWidgetObject=d;this.uiWidegetCallbackMethod=c;this.emailAddress=b;this.cid=a&&a.indexOf("cid:")==-1?"cid:"+a:a;this.key=!String.isNullOrEmpty(a)&&a!=0?a:b;this.id=this.key+Math.random();this.state=e};PresenceManager.Subscription.prototype={id:null,uiWidgetObject:null,uiWidegetCallbackMethod:null,emailAddress:null,cid:null,key:null,delegate:null,state:null,isSame:function PresenceManager_Subscription$isSame(a){if(this.id===a.id)return true;return false},dispose:function PresenceManager_Subscription$dispose(){this.id=null;this.uiWidgetObject=null;this.uiWidegetCallbackMethod=null;this.emailAddress=null;this.cid=null;this.key=null;this.delegate=null;this.state=null}};PresenceManager.subscribeUtility=function PresenceManager$subscribeUtility(c,a){a.delegate=Delegate.create(a.uiWidgetObject,a.uiWidegetCallbackMethod);c._subscriptions[a.id]=a;var b=c._subscriptionsByKey[a.key];if(b==null)b=c._subscriptionsByKey[a.key]=[];b.push(a.id);return b};PresenceManager.unsubscribeUtility=function PresenceManager$unsubscribeUtility(c,a){var e=-1,b=c._subscriptionsByKey[a.key];if(b){for(var d=b.length;d>=0;d--)if(b[d]==a.id){e=d;break}if(e!=-1){b.splice(e,1);if(b.length==0){c._subscriptionsByKey[a.key]=null;delete c._subscriptionsByKey[a.key];delete b}c._subscriptions[a.id]=null;delete c._subscriptions[a.id];a.delegate=null}}};PresenceManager.Cache=function PresenceManager$Cache(){};PresenceManager.Cache.prototype={_cache:{},checkAndSet:function PresenceManager_Cache$checkAndSet(b,a){if(this._cache[b]!=a){this._cache[b]=a;return true}return false}};PresenceManager.WebInterface=function PresenceManager_WebInterface$(a){this._webIM=a;this._cache=new PresenceManager.Cache;this._presenceChangedHandler=this._webIM.createDelegate(this,this._presenceChanged);a.add_presenceChanged(this._presenceChangedHandler)};PresenceManager.WebInterface.prototype={_webIM:null,_subscriptions:{},_subscriptionsByKey:{},_presenceChangedHandler:null,_cache:null,_isActive:false,_translateFromServerStatus:function PresenceManager_WebInterface$_translateFromServerStatus(c){try{var b=Enum.toString(Microsoft.Live.Messenger.PresenceStatus,c),a=gActivexStatusLookup[b];return a}catch(d){}return gActivexStatusLookup.offline},_presenceChanged:function PresenceManager_WebInterface$_presenceChanged(a){this._changePresence(a,false)},_changePresence:function PresenceManager_WebInterface$_changePresence(j,u){var c,g=null;if(Microsoft.Live.Messenger.IMAddress.isInstance(j))c=j;else{g=j;c=g.get_currentAddress()}if(c){var b=c.get_presence(),m=b?b.get_status():Microsoft.Live.Messenger.PresenceStatus.offline,p=this._translateFromServerStatus(m),h=c.get_cid(),d=c.get_address(),v=String.isNullOrEmpty(h)?d:h,f=b?b.get_displayName():null;if(String.isNullOrEmpty(f))f=d;var n=b?b.get_displayPictureUrl():null,o=g?g.get_isBlocked():false,r=b?LinkAndEmoticonReplacedHtml(b.get_personalMessage()):null,t=["",p,f,n,o,r].join();if(u||this._cache.checkAndSet(k,t)){var q=[h,d],a=null;for(var s=q.length;s--;){var k=q[s];if(String.isNullOrEmpty(k))continue;var i=this._subscriptionsByKey[k];if(!i)continue;for(var l=i.length-1;l>=0;l--){var e=this._subscriptions[i[l]];if(e&&e.delegate){if(a==null){a=new PresenceManager.PresenceInfo;a.source="web";a.displayName=f;a.emailAddress=d;a.psm=r;a.displayUrl=n;a.webimStatus=m;a.status=p;a.isBlocked=o;a.cid=h;a.isSelf=c.equals(this._webIM.get_user().get_address())}a.state=e.state;e.delegate.invoke(a);gDebugMessager.write("Status for: "+a.displayName+" changed to "+a.status)}}delete a}}}},subscribe:function PresenceManager_WebInterface$subscribe(a){PresenceManager.subscribeUtility(this,a);var b=gWebIM.findContact(a.cid,a.emailAddress);if(b)this._changePresence(b,true);else if(String.equals(gWebIM.get_selfAddress().get_address(),a.emailAddress,true))this._changePresence(gWebIM.get_selfAddress(),true)},unsubscribe:function PresenceManager_WebInterface$unsubscribe(a){PresenceManager.unsubscribeUtility(this,a)},chat:function PresenceManager_$chat(b,c){var a=this._webIM.get_chatManager();if(a!=null)a.chat(b,c)},isUsingWeb:function PresenceManager_WebInterface$isUsingWeb(){return true},getLocalUserStatus:function PresenceManager_WebInterface$getLocalUserStatus(){if(this._webIM){var b=this._webIM.get_user();if(b){var a=b.get_presence();if(a)return this._translateFromServerStatus(a.get_status())}}return PresenceManager.ActiveXStatus.offline},setIsActive:function PresenceManager_WebInterface$setIsActive(a){this._isActive=a},isActive:function PresenceManager_WebInterface$isActive(){return this._isActive},dispose:function PresenceManager_WebInterface$dispose(){this._webIM.remove_presenceChanged(this._presenceChangedHandler);this._presenceChangedHandler=null;this._webIM=null;for(var a in this._subscriptions)this.unsubscribe(this._subscriptions[a])}};PresenceManager.ActiveXInterface=function PresenceManagager_ActiveXInterface(){this._cache=new PresenceManager.Cache};PresenceManager.ActiveXInterface.prototype={_userEmailAddress:null,_userCid:null,_msngr:null,_subscriptions:{},_subscriptionsByKey:{},_pollID:0,_cache:null,_isActive:true,_pollOne:function PresenceManager_ActiveXInterface$_pollOne(d,k,h){try{if(d&&this._msngr){var e=d.emailAddress,j=d.cid,f=!String.isNullOrEmpty(j)?j:e;if(!String.isNullOrEmpty(f)){var i=e==gUser,c;if(!this.islocalUserOnline())c=PresenceManager.ActiveXStatus.offline;else if(i)c=this._msngr.GetLocalUserStatus();else c=this._msngr.GetUserStatus(f);if(k||this._cache.checkAndSet(f,c)){var a=null;for(var g=h.length-1;g>=0;g--){var b=this._subscriptions[h[g]];if(b&&b.delegate){if(a==null){a=new PresenceManager.PresenceInfo;a.status=c;a.source="activex";a.emailAddress=e;a.isSelf=i;a.cid=b.cid}a.state=b.state;b.delegate.invoke(a)}}delete a}}}}catch(l){}},_poll:function PresenceManager_ActiveXInterface$_poll(){for(var c in this._subscriptionsByKey){var a=this._subscriptionsByKey[c];if(a&&a.length>0&&this._subscriptions){var b=this._subscriptions[a[0]];if(b)this._pollOne(b,false,a)}}},initialize:function PresenceManager_ActiveXInterface$initialize(a,b){this._userEmailAddress=a;this._userCid=b;if(window.navigator.userAgent.indexOf("MSIE")>0)try{this._msngr=new ActiveXObject("MSNMessenger.Hotmail2Control");this._msngr.GetLocalUserStatus()}catch(c){this._msngr=null}},getLocalUserStatus:function PresenceManager_ActiveXInterface$getLocalUserStatus(){var a=PresenceManager.ActiveXStatus.offline;if(this._msngr&&this._msngr.IsUser(this._userEmailAddress))a=this._msngr.GetLocalUserStatus();return a},islocalUserOnline:function PresenceManager_ActiveXInterface$islocalUserOnline(){if(this._msngr&&this._msngr.IsUser(this._userEmailAddress)){var a=this._msngr.GetLocalUserStatus();return a!=PresenceManager.ActiveXStatus.offline}return false},subscribe:function PresenceManager_ActiveXInterface$subscribe(a){var b=PresenceManager.subscribeUtility(this,a);this._pollOne(a,true,b);if(this._pollID===0)this._pollID=window.setInterval(Delegate.create(this,this._poll),5e3)},unsubscribe:function PresenceManager_ActiveXInterface$unsubscribe(a){PresenceManager.unsubscribeUtility(this,a)},chat:function PresenceManager_ActiveXInterface$chat(a,b){if(this.islocalUserOnline())if(a&&this._userEmailAddress!=a)this._msngr.InstantMessage(a);else if(b&&this._userCid!=b)this._msngr.InstantMessage(b);else this._msngr.ShowContactList()},isUsingWeb:function PresenceManager_ActiveXInterface$isUsingWeb(){return false},setIsActive:function PresenceManager_WebInterface$setIsActive(a){this._isActive=a;if(a){if(this._subscriptionsByKey.length>0&&this._pollID===0)this._pollID=window.setInterval(Delegate.create(this,this._poll),5e3)}else if(this._pollID!=0){clearInterval(this._pollID);this._pollID=0}},isActive:function PresenceManager_WebInterface$isActive(){return this._isActive},dispose:function PresenceManager_ActiveXInterface$dispose(){if(this._pollID!=0){clearInterval(this._pollID);this._pollID=0}for(var a in this._subscriptions)this.unsubscribe(this._subscriptions[a]);this._subscriptions=null;this._msngr=null;this._userEmailAddress=null;this._userCid=null}};PresenceManager.prototype={_im:null,_subscriptions:[],setIM:function PresenceManager$setIM(a){var b=this._im;this._im=a;if(b||a)for(var c=this._subscriptions.length-1;c>=0;c--){if(b){b.unsubscribe(this._subscriptions[c]);b.setIsActive(false)}if(a){a.subscribe(this._subscriptions[c]);a.setIsActive(true)}}},subscribe:function PresenceManager$subscribe(e,d,c,a,f){var b=null;if(!String.isNullOrEmpty(c)||!String.isNullOrEmpty(a)&&a!="cid:0"&&a!=0){var b=new PresenceManager.Subscription(e,d,c,a,f);this._subscriptions.push(b);if(this._im)this._im.subscribe(b)}return b},unsubscribe:function PresenceManager$unsubscribe(a){if(a){var b=-1;for(b=this._subscriptions.length-1;b>=0;b--)if(this._subscriptions[b].isSame(a))break;if(b!=-1){if(this._im&&a.emailAddress)this._im.unsubscribe(a);this._subscriptions.splice(b,1);a.dispose();delete a}}return null},chat:function PresenceManager$chat(a,b){if(!this._im||this._im.getLocalUserStatus()==PresenceManager.ActiveXStatus.offline)alert(gStrings.SignInToChat);else this._im.chat(a,b)},dispose:function PresenceManager$dispose(){this.setIM(null);while(this._subscriptions.length>0){var a=this._subscriptions.pop();a.dispose();delete a}}};MailIM.ImClient=function MailIM_ImClient$(){this._signInCompletedHandler=Delegate.create(this,this._signInCompleted);this._signOutCompletedHandler=Delegate.create(this,this._signOutCompleted);gWebIM.add_signInCompleted(this._signInCompletedHandler);gWebIM.add_signOutCompleted(this._signOutCompletedHandler);if(!this._checkActiveX()&&gWebIM.isSignedIn())this._webIM=new PresenceManager.WebInterface(gWebIM);this._presenceManager=new PresenceManager;this._im=this._activeX&&this._activeX.isActive()?this._activeX:this._webIM;if(this._im!=null)this._presenceManager.setIM(this._im)};MailIM.ImClient.prototype={_signInCompletedHandler:null,_signOutCompletedHandler:null,_activeX:null,_webIM:null,_presenceManager:null,_im:null,_clearActiveX:function MailIM_ImClient$_clearActiveX(){if(this._activeX&&this._im!=this._activeX){this._activeX.dispose();this._activeX=null}},_clearWebIM:function MailIM_ImClient$_clearWebIM(){if(this._webIM&&!this._im!=this._webIM){this._webIM.dispose();this._webIM=null}},_checkActiveX:function MailIM_ImClient$_checkActiveX(){if(isIE()&&!this._activeX){this._activeX=new PresenceManager.ActiveXInterface;this._activeX.initialize(gUser)}return this._activeX},_signInCompleted:function MailIM_ImClient$_signInCompleted(a){if(a){this._im=this._webIM=new PresenceManager.WebInterface(gWebIM);if(this._im!=null)this._presenceManager.setIM(this._im)}},_signOutCompleted:function MailIM_ImClient$_signOutCompleted(){this._im=this._checkActiveX();this._presenceManager.setIM(this._im);this._clearWebIM()},get_presenceManager:function MailIM_ImClient$get_presenceManager(){return this._presenceManager},isUsingWeb:function MailIM_ImClient$isUsingWeb(){if(this._im)return this._im.isUsingWeb();return false},getLocalUserStatus:function MailIM_ImClient$getLocalUserStatus(){if(this._im)return this._im.getLocalUserStatus();return PresenceManager.ActiveXStatus.offline},signIn:function MailIM_ImClient$signIn(a){gWebIM.signIn(gUser,a)},changeStatus:function MailIM_ImClient$changeStatus(a){if(this._webIM)return gWebIM.changeStatus(a);return Microsoft.Live.Messenger.PresenceStatus},signOut:function MailIM_ImClient$signOut(a){if(this._webIM)gWebIM.signOut(a)},dispose:function MailIM_ImClient$dispose(){gWebIM.remove_signInCompleted(this._signInCompletedHandler);gWebIM.remove_signOutCompleted(this._signOutCompletedHandler);this._signInCompletedHandler=null;this._signOutCompletedHandler=null;this._presenceManager.dispose();this._presenceManager=null;this._im=null;this._clearActiveX();this._clearWebIM()}};var gWebIMOptionsMenu="WebIMOptionsMenu",gWebIMSignInMenu="WebIMSignInMenu",gWebIMSignInMenuButton="WebIMSignInMenuButton",gWebIMOptionsMenuButton="WebIMOptionsMenuButton",gWebIMSignOutEverywhere="WebIMSignOutEverywhere",gWebIMSignoutEverywhereText="WebIMSignoutEverywhereText",gWebIMSignOutEverywhereLI="WebIMSignOutEverywhereLI",gSignInAlwaysCookieName=gUserHash+"_A",gWebIMUserStatusCookieName=gUserHash+"_S";function closeMenu(b){try{if(b){var c=b.getAttribute("menuid"),a=null;if(c){a=b.ownerDocument.getElementById(c);if(a){var d=a.menu;if(d)d.toggleState()}}return a}}catch(e){}return null}function assignButtonText(a,b){a.innerText=b;if(isIE6()&&!isNaN(gButtonTextLength)){a.style.width="auto";if(a.clientWidth>gButtonTextLength)a.style.width=gButtonTextLength+"px"}}function UISignIn(a){if(a){closeMenu(a);gBuddyListManager._hideBuddyList();if(a.id=="WebIMSignInAlways")setWebIMCookie(gSignInAlwaysCookieName,"1",false)}gImUI.signIn(null)}function UISignOut(a){if(a){closeMenu(a);gBuddyListManager._hideBuddyList();var b=gImUI.signOut(a&&a.id==gWebIMSignOutEverywhere);if(b)setWebIMCookie(gSignInAlwaysCookieName,"",false);return b}return true}function UIStatusChange(a){if(a){var d=closeMenu(a);gBuddyListManager._hideBuddyList();var b=a.getAttribute("value"),g=gImClient.changeStatus(b);try{var c=$(gWebIMOptionsMenuButton),h=d.getElementsByTagName("span")[0],f=c.getElementsByTagName("span")[0],e=a.getAttribute("text");assignButtonText(f,e);assignButtonText(h,e);var k=d.getElementsByTagName("img")[0],i=c.getElementsByTagName("img")[0],j=gStatusImageMap.getImageMapWithPawn(g);i.src=k.src=j;if(gWebIM.isSignedIn())setWebIMCookie(gWebIMUserStatusCookieName,b=="online"?"":b,false)}catch(l){}}}function UIViewBuddies(a){if(a){closeMenu(a);return gBuddyListManager._showBuddyList()}}function setOnlineContactsBuddyList(a){gBuddyListManager._hideBuddyList();gBuddyListManager._BuddyListCollection=gWebIM.get_user().get_onlineContacts();if(gBuddyListManager._BuddyListCollection!=null){var b=gBuddyListManager._BuddyListCollection.get_count();a.innerHTML=["(",b,")"].join("")}else a.innerHTML=""}function UIViewClientBuddies(a){if(a){closeMenu(a);gBuddyListManager._hideBuddyList();gImClient.get_presenceManager().chat(null,null);return false}}function UIReportAbuse(a){if(a){closeMenu(a);gBuddyListManager._hideBuddyList();var b=" https://support.live.com/default.aspx?productKey=wlmessengerabuse&mkt="+gMarket;window.open(b,"_blank")}}function UIChat(){if(this)gImClient.get_presenceManager().chat(this.getAttribute("email"))}function UISignOutOfPassport(){if(gWebIM.isSignedIn())return gImUI.signOut(false);return true}function UIRespondToChat(a){if(a){var b=gWebIM.get_chatManager();if(b)b.respondToChat(a)}}function UIUpdateForPresenceContainer(a){if(gImUI)gImUI.updateForPresenceContainer(a)}MailIM.ImUI=function MailIM_ImUI$(){this._signInCompletedHandler=Delegate.create(this,this._signInCompleted);this._signOutCompletedHandler=Delegate.create(this,this._signOutCompleted);this._onIncomingChatHandler=Delegate.create(this,this._onIncomingChat);this._newSignInOutHandler=Delegate.create(this,this._newSignInOut);this._UIWindowUnloadHandler=Delegate.create(this,this._UIWindowUnloaded);gWebIM.add_signInCompleted(this._signInCompletedHandler);gWebIM.add_signOutCompleted(this._signOutCompletedHandler);gWebIM.add_onIncomingChat(this._onIncomingChatHandler);gWebIM.add_newSignInOut(this._newSignInOutHandler);this._selfSubscription=gImClient.get_presenceManager().subscribe(this,this.updatePresence,gUser,gCid,null)};MailIM.ImUI.prototype={_signInCompletedHandler:null,_signOutCompletedHandler:null,_onIncomingChatHandler:null,_newSignInOutHandler:null,_UIWindowUnloadHandler:null,_subscriptions:{},_signingIn:false,_selfSubscription:null,_window:function MailIM_ImUI$_window(){var a;try{a=getUiWindow();var c=a.document}catch(b){a=null}return a},_injectMenu:function MailIM_ImUI$_injectMenu(c,a){if(a){var b=document.getElementById(c);a.style.cssText=b.style.cssText;a.innerHTML=b.innerHTML;a.style.display="block"}},_initializeICPresence:function MailIM_ImUI$_initializeICPresence(a){try{if(a&&a.$cxp_ic){a.gPresenceManager=gImClient.get_presenceManager();if(a.gPresenceManager)a.$cxp_ic.presence.startWeb()}}catch(b){}},_adjustSignoutEverywhere:function MailIM_ImUI$_adjustSignoutEverywhere(d){var c=gWebIM.getSignedInLocationCount(),a=d.getElementById(gWebIMSignOutEverywhereLI),b=d.getElementById(gWebIMSignoutEverywhereText);if(c>1){var e=String.format(gStrings.SignoutEverywhere,c);b.innerText=e;if(a)a.style.display="block"}else if(a)a.style.display="none";b=null;a=null},_adjustStatusForElement:function MailIM_ImUI$_adjustStatusForElement(a,f,c,h){var b=gStatusTextMap.getItem(c);if(f!=null)assignButtonText(f,b);if(a!=null){var d=a.getAttribute("src"),e=h?gStatusImageMap.getImageMapWithPawn(c):gStatusImageMap.getImageMap(c),g=e.toLowerCase();if(d==null||d.toLowerCase().indexOf(g)==-1){a.setAttribute("src",e);a.setAttribute("alt",b);a.setAttribute("title",b)}}return b},_adjustSignInMenu:function MailIM_ImUI$_adjustSignInMenu(d,e){var a=d.getElementById("WebIMSignInButtonIcon"),c=d.getElementById("WebIMSignInButtonText"),b=d.getElementById("WebIMViewClientBuddiesLI");if(!gWebIM.isSignedIn()&&e!=Microsoft.Live.Messenger.PresenceStatus.offline){this._adjustStatusForElement(a,c,e,true);if(b)b.style.display="block"}else if(c&&a&&b){assignButtonText(c,gStrings.SignInButton);a.setAttribute("src",getImage("im/webim16_wp.gif"));a.setAttribute("alt",gStrings.SignInButton);a.setAttribute("title",gStrings.SignInButton);b.style.display="none"}c=null;a=null;b=null},_adjustOptionsMenu:function MailIM_ImUI$_adjustOptionsMenu(d,b){try{var a=d.getElementById(gWebIMOptionsMenuButton);if(a){var e=a.getElementsByTagName("img")[0],c=a.getElementsByTagName("span")[0];this._adjustStatusForElement(e,c,b,true)}}catch(f){}},_initializeUI:function MailIM_ImUI$_initializeUI(a,b){if(a){var d=b["document"];if(!gWebIM.isSignedIn()){var c=this._translateFromClientStatus(gImClient.getLocalUserStatus());this._adjustSignInMenu(document,c);this._injectMenu(gWebIMSignInMenu,a);this._doCommonUIChore(b,this._setSigningInText)}else{this._adjustSignoutEverywhere(document);this._adjustOptionsMenu(document,gWebIM.get_user().get_presence().get_status());this._injectMenu(gWebIMOptionsMenu,a);this._adjustSignoutEverywhere(d)}}},_uninitializeUI:function MailIM_ImUI$_uninitializeUI(){},_getUIElements:function MailIM_ImUI$_getUIElements(b){var a=this._window(),e=false;if(a){b["window"]=a;var c=a.document;b["document"]=c;var d=b["marker"]=c.getElementById("WebIMMenu");a=null;return d}return null},_disposeUIElements:function MailIM_ImUI$_disposeUIElements(a){for(var b in a)a[b]=null;return null},_signInCompleted:function MailIM_ImUI$_signInCompleted(b,a){this._signingIn=false;if(b)this._doCommonUIChore(a,this._initializeUI);else{gToastManager.signInFailure();this._doCommonUIChore(a,this._adjustForSignInFailure)}},_adjustForSignInFailure:function MailIM_ImUI$_adjustForSignInFailure(b){this._setSigningInText(b);var a=this._translateFromClientStatus(gImClient.getLocalUserStatus());this._adjustSignInMenu(document,a);this._adjustSignInMenu(b["document"],a)},_doCommonUIChore:function MailIM_ImUI$_doCommonUIChore(a,c){var d=false,b=null;if(a==null){a={};b=this._getUIElements(a);d=true}else b=a["marker"];if(b){if(c===this._setSigningInText)this._setSigningInText(a);else if(c===this._initializeUI)this._initializeUI(b,a);else if(c==this._adjustForSignInFailure)this._adjustForSignInFailure(a);if(d)a=this._disposeUIElements(a)}b=null},_putupSignInUI:function MailIM_ImUI$_putupSignInUI(a){this._doCommonUIChore(a,this._initializeUI)},_signOutCompleted:function MailIM_ImUI$_signOutCompleted(a){if(a)gToastManager.remotelySignedOut();this._putupSignInUI(null)},_setSigningInText:function MailIM_ImUI$_setSigningInText(h){try{var g=h["document"],e=g.getElementById(gWebIMSignInMenuButton),a=e?e.parentNode:null;if(a){if(this._signingIn){var b=$(gWebIMSignInMenuButton),d=a.getElementsByTagName("span")[0],c=b.getElementsByTagName("span")[0],f=gStrings.SigningIn;assignButtonText(c,f);assignButtonText(d,f);b=c=d=null}else this._adjustSignInMenu(g,this._translateFromClientStatus(gImClient.getLocalUserStatus()));a=null}}catch(i){}},_attachHandle:function MailIM_ImUI$_attachHandle(a,b,c){if(a)if(isIE())a.attachEvent("on"+b,c);else a.addEventListener(b,c,false)},_detachHandle:function MailIM_ImUI$_detachHandle(a,b,c){if(a)if(isIE())a.detachEvent("on"+b,c);else a.removeEventListener(b,c,false)},_UIWindowUnloaded:function MailIM_ImUI$_UIWindowUnloaded(){try{var e=getUiWindow();this._detachHandle(e,"unload",this._UIWindowUnloadHandler);var a={},b=this._getUIElements(a);if(b){this._uninitializeUI(b,a);var g=gImClient.get_presenceManager(),d=a["document"];this._clearSubscriptions(d);var c=d.getElementById("c_signout");this._detachHandle(c,"click",UISignOutOfPassport);a=this._disposeUIElements(a);b=c=null}e=null}catch(f){}},_clearSubscriptions:function MailIM_ImUI$_clearSubscriptions(d){if(d){var b=d.getElementsByTagName("S"),f=gImClient.get_presenceManager();for(var e=b.length;e--;){var c=b[e],h=c.getAttribute("app");if(h=="WEBIM"){var a=c.getAttribute("for");if(!String.isNullOrEmpty(a)){var g=this._subscriptions[a];f.unsubscribe(g);this._subscriptions[a]=null;delete this._subscriptions[a]}}c=null}b=null}},_setupSubscriptions:function MailIM_ImUI$_setupSubscriptions(g){var b=g.getElementsByTagName("S"),f=gImClient.get_presenceManager();for(var e=b.length;e--;){var a=b[e],h=a.getAttribute("app");if(h=="WEBIM"){var c=a.getAttribute("for"),d=a.getAttribute("email");if(!String.isNullOrEmpty(c)&&!String.isNullOrEmpty(d))this._subscriptions[c]=f.subscribe(this,this.updatePresence,d,null,c)}a=null}b=null},_onIncomingChat:function MailIM_WebIM$_onIncomingChat(c,a,b){gToastManager.createToastForNewMessage(c,a,b)},_getStoredStatus:function MailIM_ImUI$_getStoredStatus(){var a=Microsoft.Live.Messenger.PresenceStatus.online,b=getWebIMCookie(gWebIMUserStatusCookieName);if(!String.isNullOrEmpty(b))try{a=Enum.parse(Microsoft.Live.Messenger.PresenceStatus,b)}catch(c){a=Microsoft.Live.Messenger.PresenceStatus.online;setWebIMCookie(gWebIMUserStatusCookieName,"",false)}return a},_checkForAutoSignIn:function MailIM_ImUI$_checkForAutoSignIn(a){if(gIsAutoSignIn||getWebIMCookie(gSignInAlwaysCookieName)=="1")this.signIn(a)},_newSignInOut:function MailIM_ImUI$_newSignInOut(b){if(b)gToastManager.newSignIn();try{var a=this._window();if(a){this._adjustSignoutEverywhere(a.document);this._adjustSignoutEverywhere(document);a=null}}catch(c){}},_updateImageForPresence:function MailIM_ImUI$_updateImageForPresence(a,d,i,c,h){var b=null;if(!i&&!d.isSelf)b=UIChat;var g=false,e=a.getAttribute("src");if(e==null||e.toLowerCase().indexOf(c.toLowerCase())==-1){a.setAttribute("src",c);var f=d.isBlocked?gStrings.Buddy_Status_Blocked:gStatusTextMap.getItem(h);a.setAttribute("alt",f);a.setAttribute("title",f);g=true}displayStyle=a.getAttribute("webimdisplayStyle");if(!String.isNullOrEmpty(displayStyle)&&a.style.display!=displayStyle)a.style.display=displayStyle;if(isIE6())gStatusImageMap.fixAlphaForIE6(a,c);if(String.isNullOrEmpty(a.getAttribute("email")))a.setAttribute("email",d.emailAddress);if(b==null!=(a.onclick==null))a.onclick=b},_translateFromClientStatus:function MailIM_ImUI$_translateFromServerStatus(b){var a;switch(b){case PresenceManager.ActiveXStatus.online:a=Microsoft.Live.Messenger.PresenceStatus.online;break;case PresenceManager.ActiveXStatus.busy:case PresenceManager.ActiveXStatus.inACall:a=Microsoft.Live.Messenger.PresenceStatus.busy;break;case PresenceManager.ActiveXStatus.beRightBack:case PresenceManager.ActiveXStatus.idle:case PresenceManager.ActiveXStatus.away:case PresenceManager.ActiveXStatus.outToLunch:a=Microsoft.Live.Messenger.PresenceStatus.away;break;case PresenceManager.ActiveXStatus.appearOffline:a=Microsoft.Live.Messenger.PresenceStatus.appearOffline;break;default:a=Microsoft.Live.Messenger.PresenceStatus.offline}return a},updatePresence:function MailIM_ImUI$updatePresence(a){if(a){var e=this._window();if(e){try{var d=e.document,c=null;if(a.state)c=d.getElementById(a.state);if(c||a.isSelf){var b;if(a.webimStatus!=Microsoft.Live.Messenger.PresenceStatus.prototype.none)b=a.webimStatus;else b=this._translateFromClientStatus(a.status);var i=gStatusImageMap.getImageMap(b,a.isBlocked);if(a.isSelf){this._adjustOptionsMenu(document,b);this._adjustOptionsMenu(d,b);this._adjustSignInMenu(document,b);this._adjustSignInMenu(d,b)}if(c){var h=b==Microsoft.Live.Messenger.PresenceStatus.offline;if(String.compare(c.tagName,"IMG",true)==0)this._updateImageForPresence(c,a,h,i,b);else{var g=c.getAttribute("handlerName");if(!String.isNullOrEmpty(g)){var f=e[g];if(f!=null)f.call(c,a,h,i,b);f=null}}c=null}}d=null}catch(j){}e=null}}},signIn:function MailIM_ImUI$signIn(a){if(!this._signingIn){var b=this._getStoredStatus();gImClient.signIn(b);this._signingIn=true;this._doCommonUIChore(a,this._setSigningInText)}},connectWith:function MailIM_ImUI$connectWith(){var a={},e=this._getUIElements(a);if(e){var b=a["window"],c=a["document"],d=c.getElementById("c_signout");this._attachHandle(b,"unload",this._UIWindowUnloadHandler);this._attachHandle(d,"click",UISignOutOfPassport);b.informWebIMOfUpdate=UIUpdateForPresenceContainer;if(!gWebIM.isSignedIn()){this._putupSignInUI(a);this._checkForAutoSignIn(a)}else this._signInCompleted(true);this._setupSubscriptions(c);this._initializeICPresence(b);a=this._disposeUIElements(a);b=c=d=null}},updateForPresenceContainer:function MailIM_ImUI$updateForPresenceContainer(a){try{var c=this._window();if(c){a=String.isNullOrEmpty(a)?"PresenceContainer":a;var b=c.document.getElementById(a);if(b)this._setupSubscriptions(b);uiElements=this._disposeUIElements(uiElements);c=b=null}}catch(d){}},navigateTo:function MailIM_ImUI$navigateTo(b){var a;try{if(!String.isNullOrEmpty(b)){a=this._window();if(a){a.location.href=b;a.focus();a=null}}}catch(c){a=null}},signOut:function MailIM_ImUI$signOut(a){if(gWebIM.isSignedIn()){var b=gWebIM.get_chatManager();if(b.hasOpenConversations())if(!window.confirm(gStrings.CW_ThereAreOpenConversations))return false;gToastManager.closeAll();gImClient.signOut(a)}return true},dispose:function MailIM_ImUI$dispose(){if(gWebIM!=null){gImClient.get_presenceManager().unsubscribe(this._selfSubscription);gWebIM.remove_newSignInOut(this._newSignInOutHandler);gWebIM.remove_onIncomingChat(this._onIncomingChatHandler);gWebIM.remove_signInCompleted(this._signInCompletedHandler);gWebIM.remove_signOutCompleted(this._signOutCompletedHandler)}this._UIWindowUnloadHandler=null;this._newSignInOutHandler=null;this._onIncomingChatHandler=null;this._signInCompletedHandler=null;this._signOutCompletedHandler=null}}